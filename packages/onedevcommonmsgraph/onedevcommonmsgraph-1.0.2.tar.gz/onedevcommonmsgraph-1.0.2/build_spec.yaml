version: 0.1
component: build
timeoutInSeconds: 3600
runAs: root
shell: bash

# â¬‡ï¸ ConfiguraÃ§Ã£o correta para secrets do OCI Vault
env:
  vaultVariables:
    PYPI_TOKEN: ocid1.vaultsecret.oc1.sa-saopaulo-1.amaaaaaasgpnwoyawqwu2uwtmyoyh7g6o65kbvjr2vfyfb622hjpne2mp7ya

# â¬‡ï¸ 2) Passos de build
steps:
  - type: Command
    name: Install Dependencies
    command: |
      echo "ğŸ“¦ Instalando dependÃªncias..."
      python3 -m pip install --upgrade pip setuptools wheel twine build
      pip install hatchling
      pip install twine
      echo "âœ… DependÃªncias instaladas!"

  - type: Command
    name: Increment Version
    command: |
      echo "ğŸ”„ Incrementando versÃ£o..."
      
      # LÃª a versÃ£o atual do pyproject.toml
      CURRENT_VERSION=$(grep 'version = ' pyproject.toml | cut -d'"' -f2)
      echo "ğŸ“‹ VersÃ£o atual: $CURRENT_VERSION"
      
      # Incrementa o Ãºltimo nÃºmero da versÃ£o
      MAJOR=$(echo $CURRENT_VERSION | cut -d. -f1)
      MINOR=$(echo $CURRENT_VERSION | cut -d. -f2)
      PATCH=$(echo $CURRENT_VERSION | cut -d. -f3)
      NEW_PATCH=$((PATCH + 1))
      NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
      
      echo "ğŸ“ˆ Nova versÃ£o: $NEW_VERSION"
      
      # Atualiza o pyproject.toml
      sed -i "s/version = \"$CURRENT_VERSION\"/version = \"$NEW_VERSION\"/" pyproject.toml
      
      echo "âœ… VersÃ£o atualizada para $NEW_VERSION"

  - type: Command
    name: Retrieve PyPI Token from Vault
    command: |
      echo "ğŸ” Recuperando token do OCI Vault..."
      
      # Define o OCID do secret
      SECRET_OCID="ocid1.vaultsecret.oc1.sa-saopaulo-1.amaaaaaasgpnwoyawqwu2uwtmyoyh7g6o65kbvjr2vfyfb622hjpne2mp7ya"
      echo "ğŸ“‹ Secret OCID: $SECRET_OCID"
      
      # Verifica se o OCI CLI estÃ¡ disponÃ­vel
      if ! command -v oci &> /dev/null; then
        echo "âŒ ERRO: OCI CLI nÃ£o encontrado!"
        exit 1
      fi
      
      echo "âœ… OCI CLI encontrado: $(oci --version)"
      
      # Tenta recuperar o secret bundle
      echo "ğŸ” Buscando secret bundle..."
      if ! SECRET_BUNDLE=$(oci secrets secret-bundle get --secret-id "$SECRET_OCID" --stage CURRENT --query 'data."secret-bundle-content".content' --raw-output 2>&1); then
        echo "âŒ ERRO ao buscar secret bundle:"
        echo "$SECRET_BUNDLE"
        echo ""
        echo "ğŸ”§ PossÃ­veis causas:"
        echo "- PermissÃµes insuficientes para acessar o Vault"
        echo "- OCID do secret incorreto"
        echo "- Secret nÃ£o existe ou foi deletado"
        exit 1
      fi
      
      echo "âœ… Secret bundle recuperado com sucesso"
      
      # Decodifica o conteÃºdo base64
      echo "ğŸ”“ Decodificando conteÃºdo..."
      if ! PYPI_TOKEN=$(echo "$SECRET_BUNDLE" | base64 -d 2>&1); then
        echo "âŒ ERRO ao decodificar base64:"
        echo "$PYPI_TOKEN"
        exit 1
      fi
      
      # Verifica se o token foi recuperado
      if [ -z "$PYPI_TOKEN" ]; then
        echo "âŒ ERRO: Token vazio apÃ³s decodificaÃ§Ã£o!"
        exit 1
      fi
      
      echo "âœ… Token recuperado com sucesso (${#PYPI_TOKEN} caracteres)"
      
      # Salva o token em um arquivo temporÃ¡rio para os prÃ³ximos steps
      echo "$PYPI_TOKEN" > /tmp/pypi_token
      echo "ğŸ’¾ Token salvo em arquivo temporÃ¡rio"

  - type: Command
    name: Build Package
    command: |
      echo "ğŸ”¨ Construindo pacote..."
      
      # Limpa builds anteriores
      rm -rf dist/ build/ *.egg-info/
      
      # Lista arquivos antes do build
      echo "ğŸ“ Arquivos antes do build:"
      ls -la
      
      # Faz o build
      python3 -m build
      
      # Verifica se os arquivos foram gerados
      echo "ğŸ“ Arquivos apÃ³s o build:"
      ls -la dist/
      
      if [ ! -d "dist" ] || [ -z "$(ls -A dist/)" ]; then
        echo "âŒ ERRO: Nenhum arquivo foi gerado em dist/"
        exit 1
      fi
      
      echo "âœ… Build concluÃ­do!"

  - type: Command
    name: Upload to PyPI
    command: |
      echo "ğŸ“¦ Iniciando upload para PyPI..."
      
      # Verifica se o arquivo de token existe
      if [ ! -f /tmp/pypi_token ]; then
        echo "âŒ ERRO: Arquivo de token nÃ£o encontrado!"
        exit 1
      fi
      
      # Recupera o token do arquivo temporÃ¡rio
      PYPI_TOKEN=$(cat /tmp/pypi_token)
      
      if [ -z "$PYPI_TOKEN" ]; then
        echo "âŒ ERRO: Token vazio!"
        exit 1
      fi
      
      echo "âœ… Token carregado (${#PYPI_TOKEN} caracteres)"
      
      # Lista arquivos antes do upload
      echo "ğŸ“ Arquivos para upload:"
      ls -la dist/
      
      # Faz o upload
      echo "ğŸš€ Fazendo upload dos pacotes..."
      python3 -m twine upload dist/* -u __token__ -p "$PYPI_TOKEN"
      
      # Remove o arquivo temporÃ¡rio por seguranÃ§a
      rm -f /tmp/pypi_token
      echo "ğŸ§¹ Arquivo temporÃ¡rio removido"
      echo "âœ… Upload concluÃ­do com sucesso!"