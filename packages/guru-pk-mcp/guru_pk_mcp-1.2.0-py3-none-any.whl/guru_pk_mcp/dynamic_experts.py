"""
åŠ¨æ€ä¸“å®¶ç”Ÿæˆç³»ç»Ÿ - æä¾›ä¸“å®¶æ¨èçš„åŸåˆ™æ€§æŒ‡å¯¼
"""

from typing import Any


class DynamicExpertManager:
    """åŠ¨æ€ä¸“å®¶ç®¡ç†å™¨ - ç®¡ç†å½“å‰ä¼šè¯çš„ä¸“å®¶"""

    def __init__(self, data_dir: str | None = None):
        # ä¿ç•™data_dirå‚æ•°ä»¥å…¼å®¹ç°æœ‰ä»£ç ï¼Œä½†å®é™…ä¸ä½¿ç”¨
        self.current_experts: dict[str, Any] = {}

    def set_current_experts(self, experts: dict[str, Any]) -> None:
        """è®¾ç½®å½“å‰ä¼šè¯çš„ä¸“å®¶"""
        self.current_experts = experts

    def get_current_experts(self) -> dict[str, Any]:
        """è·å–å½“å‰ä¼šè¯çš„ä¸“å®¶"""
        return self.current_experts

    def clear_current_experts(self) -> None:
        """æ¸…é™¤å½“å‰ä¸“å®¶"""
        self.current_experts = {}

    def validate_expert_data(self, expert_data: dict[str, Any] | None) -> bool:
        """éªŒè¯ä¸“å®¶æ•°æ®å®Œæ•´æ€§"""
        if expert_data is None:
            return False

        required_fields = [
            "name",
            "description",
            "core_traits",
            "speaking_style",
            "base_prompt",
        ]

        for field in required_fields:
            if field not in expert_data or not expert_data[field]:
                return False

        # æ·»åŠ é»˜è®¤emoji
        if "emoji" not in expert_data:
            expert_data["emoji"] = "ğŸ‘¤"

        return True

    def format_expert_list(self, experts: dict[str, Any]) -> list[dict[str, Any]]:
        """æ ¼å¼åŒ–ä¸“å®¶åˆ—è¡¨ç”¨äºæ˜¾ç¤º"""
        return [
            {
                "name": expert["name"],
                "emoji": expert.get("emoji", "ğŸ‘¤"),
                "description": expert["description"],
                "core_traits": expert["core_traits"],
                "speaking_style": expert["speaking_style"],
                # ç§»é™¤ç¡¬ç¼–ç çš„çœŸå®äººç‰©åˆ¤æ–­ï¼Œäº¤ç»™MCP Hostç«¯LLMå¤„ç†
                # "is_real_person": self._is_likely_real_person(expert),
            }
            for expert in experts.values()
        ]


def get_question_analysis_guidance() -> str:
    """è·å–é—®é¢˜åˆ†ææŒ‡å¯¼åŸåˆ™ï¼ˆä¾›MCP Hostç«¯LLMä½¿ç”¨ï¼‰"""
    return """
# é—®é¢˜åˆ†ææŒ‡å¯¼åŸåˆ™

## åˆ†æç»´åº¦
è¯·ä»ä»¥ä¸‹ç»´åº¦åˆ†æé—®é¢˜ï¼š

### 1. é—®é¢˜å¤æ‚åº¦
- ç®€å•é—®é¢˜ï¼šè¡¨è¿°æ¸…æ™°ã€ç­”æ¡ˆç›¸å¯¹æ˜ç¡®
- ä¸­ç­‰å¤æ‚åº¦ï¼šæ¶‰åŠå¤šä¸ªå› ç´ ã€éœ€è¦æƒè¡¡
- é«˜å¤æ‚åº¦ï¼šå¤šé¢†åŸŸäº¤å‰ã€å­˜åœ¨äº‰è®®ã€éœ€è¦æ·±åº¦æ€è€ƒ

### 2. é—®é¢˜ç±»å‹
- æ–¹æ³•å’¨è¯¢ï¼š"å¦‚ä½•"ã€"æ€ä¹ˆ"ç±»é—®é¢˜
- åŸå› åˆ†æï¼š"ä¸ºä»€ä¹ˆ"ã€"åŸå› "ç±»é—®é¢˜
- å†³ç­–æ”¯æŒï¼š"é€‰æ‹©"ã€"å†³ç­–"ç±»é—®é¢˜
- è¶‹åŠ¿é¢„æµ‹ï¼š"æœªæ¥"ã€"è¶‹åŠ¿"ç±»é—®é¢˜
- å¯¹æ¯”åˆ†æï¼š"æ¯”è¾ƒ"ã€"å¯¹æ¯”"ç±»é—®é¢˜

### 3. é¢†åŸŸè¯†åˆ«
è¯†åˆ«é—®é¢˜æ‰€æ¶‰åŠçš„ä¸»è¦é¢†åŸŸï¼š
- å•†ä¸šç®¡ç†ï¼šä¼ä¸šç»è¥ã€æŠ•èµ„ã€å¸‚åœºè¥é”€
- ç§‘æŠ€åˆ›æ–°ï¼šæŠ€æœ¯å‘å±•ã€äººå·¥æ™ºèƒ½ã€æ•°å­—åŒ–
- å“²å­¦æ€è¾¨ï¼šä»·å€¼è§‚ã€é“å¾·ä¼¦ç†ã€å­˜åœ¨æ„ä¹‰
- å¿ƒç†è¡Œä¸ºï¼šæƒ…ç»ªç®¡ç†ã€è®¤çŸ¥åå·®ã€äººé™…å…³ç³»
- æ•™è‚²æˆé•¿ï¼šå­¦ä¹ æ–¹æ³•ã€çŸ¥è¯†ä½“ç³»ã€èƒ½åŠ›åŸ¹å…»
- ç¤¾ä¼šæ–‡åŒ–ï¼šåˆ¶åº¦è®¾è®¡ã€æ–‡åŒ–ä¼ æ‰¿ã€å…¬å…±æ”¿ç­–
- å¥åº·ç”Ÿæ´»ï¼šèº«å¿ƒå¥åº·ã€ç”Ÿæ´»æ–¹å¼ã€å…»ç”Ÿä¿å¥
- åˆ›æ–°è®¾è®¡ï¼šåˆ›æ„æ€ç»´ã€äº§å“è®¾è®¡ã€ç”¨æˆ·ä½“éªŒ
- é¢†å¯¼ç®¡ç†ï¼šå›¢é˜Ÿå»ºè®¾ã€å†³ç­–åˆ¶å®šã€æ²Ÿé€šåè°ƒ
- æˆ˜ç•¥è§„åˆ’ï¼šé•¿æœŸå‘å±•ã€ç«äº‰ä¼˜åŠ¿ã€èµ„æºé…ç½®

## åˆ†æè¦æ±‚
- å‡†ç¡®è¯†åˆ«é—®é¢˜çš„æ ¸å¿ƒè¦ç´ 
- åˆ¤æ–­é—®é¢˜çš„å¤æ‚ç¨‹åº¦å’Œè®¨è®ºæ·±åº¦éœ€æ±‚
- è¯†åˆ«ç›¸å…³çš„çŸ¥è¯†é¢†åŸŸå’Œä¸“ä¸šèƒŒæ™¯
- è€ƒè™‘ä¸åŒè§†è§’å’Œè§‚ç‚¹çš„ä»·å€¼
"""


def get_expert_recommendation_guidance(
    question: str = "", expert_preferences: str = ""
) -> str:
    """è·å–ä¸“å®¶æ¨èæŒ‡å¯¼åŸåˆ™ï¼ˆä¾›MCP Hostç«¯LLMä½¿ç”¨ï¼‰"""

    # æ„å»ºåŸºç¡€æŒ‡å¯¼å†…å®¹
    base_guidance = f"""
# ä¸“å®¶æ¨èæŒ‡å¯¼åŸåˆ™

## å½“å‰ä»»åŠ¡ä¿¡æ¯
**ç”¨æˆ·é—®é¢˜**: {question}
"""

    # å¦‚æœæä¾›äº†æ˜¾å¼çš„ä¸“å®¶åå¥½ï¼Œæ·»åŠ åˆ°æŒ‡å¯¼ä¸­
    if expert_preferences:
        base_guidance += f"**ç”¨æˆ·æ˜ç¡®æŒ‡å®šçš„ä¸“å®¶åå¥½**: {expert_preferences}\n"

    # æ·»åŠ ä¸“å®¶åå¥½æå–æŒ‡å¯¼
    base_guidance += """
## ğŸ” ç¬¬ä¸€æ­¥ï¼šåˆ†æé—®é¢˜ä¸­çš„ä¸“å®¶åå¥½

è¯·ä»”ç»†åˆ†æç”¨æˆ·é—®é¢˜ï¼Œæå–å…¶ä¸­åŒ…å«çš„ä¸“å®¶åå¥½ä¿¡æ¯ï¼š

### åå¥½æå–è¦ç‚¹
1. **ç›´æ¥è¡¨è¾¾çš„åå¥½**ï¼š
   - "è¯·ä¸¤ä½äººå·¥æ™ºèƒ½é¢†åŸŸçš„ä¸“å®¶..."
   - "å¸Œæœ›æœ‰å“²å­¦å®¶å’Œç§‘å­¦å®¶å‚ä¸..."
   - "éœ€è¦å•†ä¸šé¢†åŸŸçš„å¤§å¸ˆ..."

2. **éšå«çš„é¢†åŸŸéœ€æ±‚**ï¼š
   - é—®é¢˜æ¶‰åŠçš„ä¸“ä¸šé¢†åŸŸï¼ˆAIã€å“²å­¦ã€å¿ƒç†å­¦ã€å•†ä¸šç­‰ï¼‰
   - é—®é¢˜çš„å¤æ‚ç¨‹åº¦å’Œæ·±åº¦éœ€æ±‚
   - éœ€è¦çš„æ€ç»´è§†è§’å’Œæ–¹æ³•è®º

3. **æ•°é‡å’Œç±»å‹è¦æ±‚**ï¼š
   - ä¸“å®¶çš„æ•°é‡è¦æ±‚
   - ä¸“å®¶çš„ç±»å‹ç»„åˆ
   - ç‰¹å®šçš„èƒŒæ™¯è¦æ±‚

### åå¥½åˆ†æç»“æœ
è¯·åˆ†æç”¨æˆ·é—®é¢˜åï¼Œæ€»ç»“æå–åˆ°çš„ä¸“å®¶åå¥½ï¼š
- **æ˜ç¡®çš„åå¥½**: [ä»é—®é¢˜ä¸­ç›´æ¥æå–çš„ä¸“å®¶è¦æ±‚]
- **éšå«çš„éœ€æ±‚**: [æ ¹æ®é—®é¢˜å†…å®¹æ¨æ–­çš„ä¸“å®¶ç±»å‹éœ€æ±‚]
- **æ¨èç­–ç•¥**: [åŸºäºåˆ†æçš„ä¸“å®¶ç»„åˆå»ºè®®]
"""

    base_guidance += """
## æ ¸å¿ƒåŸåˆ™ï¼šçœŸå®äººç‰©ä¼˜å…ˆ

### 1. ä¸“å®¶é€‰æ‹©ä¼˜å…ˆçº§
**ç¬¬ä¸€ä¼˜å…ˆï¼šçœŸå®äººç‰©**
- ä¼˜å…ˆä»çœŸå®å­˜åœ¨æˆ–å­˜åœ¨è¿‡çš„çŸ¥åäººç‰©ä¸­é€‰æ‹©
- åŒ…æ‹¬å·²æ•…çš„å†å²äººç‰©å’Œåœ¨ä¸–çš„å½“ä»£åäºº
- è¿™äº›äººç‰©åº”åœ¨å…¶é¢†åŸŸæœ‰å…¬è®¤çš„æˆå°±å’Œç‹¬ç‰¹çš„æ€æƒ³ä½“ç³»
- èƒ½å¤Ÿæä¾›å…·æœ‰æƒå¨æ€§å’Œä¸€è‡´æ€§çš„è§‚ç‚¹

**ç¬¬äºŒä¼˜å…ˆï¼šè™šæ‹Ÿä¸“å®¶**
- åªæœ‰å½“æŸä¸ªç‰¹å®šè§†è§’æ‰¾ä¸åˆ°åˆé€‚çš„çœŸå®äººç‰©æ—¶ï¼Œæ‰åˆ›å»ºè™šæ‹Ÿä¸“å®¶
- è™šæ‹Ÿä¸“å®¶åº”ä»£è¡¨æŸç§ç‰¹å®šçš„ä¸“ä¸šè§†è§’æˆ–æ–¹æ³•è®º
- å‘½ååº”ä¸“ä¸šåŒ–ï¼Œé¿å…è¿‡äºé€šä¿—ï¼ˆå¦‚"è®¤çŸ¥ç§‘å­¦ä¸“å®¶"è€Œé"ç‹å¿ƒç†"ï¼‰

### 2. çœŸå®äººç‰©æ¨èæŒ‡å—

#### å“²å­¦æ€è¾¨é¢†åŸŸ
- **å¤å…¸å“²å­¦**ï¼šè‹æ ¼æ‹‰åº•ã€æŸæ‹‰å›¾ã€äºšé‡Œå£«å¤šå¾·ã€å­”å­ã€è€å­
- **ç°ä»£å“²å­¦**ï¼šå°¼é‡‡ã€åº·å¾·ã€é»‘æ ¼å°”ã€ç½—ç´ ã€ç»´ç‰¹æ ¹æ–¯å¦
- **ä¸œæ–¹æ™ºæ…§**ï¼šç‹é˜³æ˜ã€æœ±ç†¹ã€ç¦…å®—å¤§å¸ˆã€ç”˜åœ°
- **å½“ä»£æ€æƒ³**ï¼šè¨ç‰¹ã€ç¦æŸ¯ã€å“ˆè´é©¬æ–¯ã€é˜¿ä¼¦ç‰¹

#### å•†ä¸šç®¡ç†é¢†åŸŸ
- **ç®¡ç†å­¦å¤§å¸ˆ**ï¼šå½¼å¾—Â·å¾·é²å…‹ã€è¿ˆå…‹å°”Â·æ³¢ç‰¹ã€å…‹é‡Œæ–¯æ»•æ£®
- **ä¼ä¸šå®¶**ï¼šä¹”å¸ƒæ–¯ã€é©¬æ–¯å…‹ã€æ¯”å°”Â·ç›–èŒ¨ã€è´ä½æ–¯ã€é©¬äº‘ã€ä»»æ­£é
- **æŠ•èµ„å¤§å¸ˆ**ï¼šå·´è²ç‰¹ã€èŠ’æ ¼ã€æ ¼é›·å„å§†ã€è¾¾é‡Œå¥¥
- **ç»æµå­¦å®¶**ï¼šå‡¯æ©æ–¯ã€å¼—é‡Œå¾·æ›¼ã€è¨ç¼ªå°”æ£®ã€å…‹é²æ ¼æ›¼

#### ç§‘æŠ€åˆ›æ–°é¢†åŸŸ
- **è®¡ç®—æœºç§‘å­¦**ï¼šå›¾çµã€å†¯Â·è¯ºä¾æ›¼ã€é¦™å†œã€é«˜å¾·çº³
- **äººå·¥æ™ºèƒ½**ï¼šè¾›é¡¿ã€æœ¬å‰å¥¥ã€æé£é£ã€å´æ©è¾¾
- **ç‰©ç†å­¦å®¶**ï¼šçˆ±å› æ–¯å¦ã€è´¹æ›¼ã€éœé‡‘ã€æ¨æŒ¯å®
- **å‘æ˜å®¶**ï¼šçˆ±è¿ªç”Ÿã€ç‰¹æ–¯æ‹‰ã€è¾¾èŠ¬å¥‡

#### å¿ƒç†è¡Œä¸ºé¢†åŸŸ
- **å¿ƒç†å­¦å¤§å¸ˆ**ï¼šå¼—æ´›ä¼Šå¾·ã€è£æ ¼ã€é˜¿å¾·å‹’ã€é©¬æ–¯æ´›
- **è®¤çŸ¥ç§‘å­¦**ï¼šå¡å°¼æ›¼ã€å¡”å‹’å¸ƒã€ä¸¹å°¼å°”Â·è¥¿è’™æ–¯
- **è¡Œä¸ºç»æµå­¦**ï¼šç†æŸ¥å¾·Â·å¡å‹’ã€ä¸¹Â·è‰¾ç‘é‡Œ

#### æ•™è‚²æˆé•¿é¢†åŸŸ
- **æ•™è‚²å®¶**ï¼šæœå¨ã€è’™å°æ¢­åˆ©ã€é™¶è¡ŒçŸ¥ã€è‹éœå§†æ—æ–¯åŸº
- **å­¦ä¹ ä¸“å®¶**ï¼šç»´æœèŒ¨åŸºã€å¸ƒé²å§†ã€åŠ å¾·çº³ï¼ˆå¤šå…ƒæ™ºèƒ½ï¼‰
- **å½“ä»£æ•™è‚²æ€æƒ³**ï¼šè‚¯Â·ç½—å®¾é€Šã€è¨å°”æ›¼Â·å¯æ±—

## ä¸“å®¶ç»„åˆç­–ç•¥

### 1. å¤šæ ·æ€§åŸåˆ™
- ç¡®ä¿ä¸“å®¶èƒŒæ™¯å¤šå…ƒåŒ–ï¼Œé¿å…è§‚ç‚¹å•ä¸€
- å¹³è¡¡ç†è®ºä¸“å®¶ä¸å®è·µä¸“å®¶
- è€ƒè™‘ä¸åŒæ–‡åŒ–èƒŒæ™¯å’Œæ€ç»´æ–¹å¼ï¼ˆä¸œè¥¿æ–¹å¹³è¡¡ï¼‰

### 2. äº’è¡¥æ€§åŸåˆ™
- é€‰æ‹©èƒ½å¤Ÿç›¸äº’è¡¥å……çš„ä¸“å®¶ç»„åˆ
- ç¡®ä¿è¦†ç›–é—®é¢˜çš„ä¸»è¦æ–¹é¢
- é¿å…ä¸“å®¶ä¹‹é—´è¿‡åº¦é‡å 

### 3. é’ˆå¯¹æ€§åŸåˆ™
- æ ¹æ®é—®é¢˜ç±»å‹é€‰æ‹©åˆé€‚çš„ä¸“å®¶
- è€ƒè™‘é—®é¢˜çš„å¤æ‚åº¦å’Œæ·±åº¦éœ€æ±‚
- åŒ¹é…ä¸“å®¶çš„ä¸“ä¸šèƒ½åŠ›ä¸é—®é¢˜éœ€æ±‚

### 4. å¹³è¡¡æ€§åŸåˆ™
- é¿å…æŸä¸€ç§è§‚ç‚¹è¿‡äºä¸»å¯¼
- ç¡®ä¿ä¸åŒç«‹åœºéƒ½æœ‰ä»£è¡¨
- ç»´æŒè®¨è®ºçš„å®¢è§‚æ€§å’Œå…¬æ­£æ€§
"""

    # å¦‚æœç”¨æˆ·æœ‰ä¸“å®¶åå¥½ï¼Œæ·»åŠ ç‰¹æ®ŠæŒ‡å¯¼
    if expert_preferences:
        base_guidance += f"""

## ğŸ¯ ç”¨æˆ·ä¸“å®¶åå¥½å¤„ç†æŒ‡å¯¼

**ç”¨æˆ·åå¥½**: {expert_preferences}

### åå¥½è§£æè¦æ±‚
1. **ç²¾ç¡®ç†è§£ç”¨æˆ·æ„å›¾**ï¼š
   - ä»”ç»†åˆ†æç”¨æˆ·åå¥½æè¿°ä¸­çš„å…³é”®è¯å’Œé¢†åŸŸ
   - è¯†åˆ«ç”¨æˆ·å¸Œæœ›çš„ä¸“å®¶ç±»å‹ã€æ•°é‡ã€ç‰¹å¾
   - ç†è§£æ˜¯å®Œå…¨æŒ‡å®šè¿˜æ˜¯éƒ¨åˆ†å»ºè®®

2. **æ™ºèƒ½åŒ¹é…ç­–ç•¥**ï¼š
   - å¦‚æœç”¨æˆ·æŒ‡å®šäº†å…·ä½“é¢†åŸŸï¼ˆå¦‚"äººå·¥æ™ºèƒ½ä¸“å®¶"ï¼‰ï¼Œä¼˜å…ˆä»è¯¥é¢†åŸŸçš„é¡¶çº§çœŸå®äººç‰©ä¸­é€‰æ‹©
   - å¦‚æœç”¨æˆ·æŒ‡å®šäº†ä¸“å®¶ç±»å‹ï¼ˆå¦‚"å“²å­¦å®¶å’Œç§‘å­¦å®¶"ï¼‰ï¼Œç¡®ä¿ç»„åˆä¸­åŒ…å«è¿™äº›ç±»å‹
   - å¦‚æœç”¨æˆ·ç»™å‡ºäº†æ¨¡ç³Šæè¿°ï¼Œæ ¹æ®é—®é¢˜å†…å®¹æ™ºèƒ½è§£é‡Šå’Œæ‰©å±•

3. **åå¥½ä¸è´¨é‡å¹³è¡¡**ï¼š
   - åœ¨æ»¡è¶³ç”¨æˆ·åå¥½çš„å‰æä¸‹ï¼Œç¡®ä¿ä¸“å®¶ç»„åˆçš„è´¨é‡å’Œå¤šæ ·æ€§
   - å¦‚æœç”¨æˆ·åå¥½è¿‡äºå±€é™ï¼Œé€‚å½“å»ºè®®äº’è¡¥çš„ä¸“å®¶ç±»å‹
   - ä¿æŒçœŸå®äººç‰©ä¼˜å…ˆçš„åŸåˆ™

### å¸¸è§åå¥½ç±»å‹å¤„ç†ç¤ºä¾‹
- **"äººå·¥æ™ºèƒ½ä¸“å®¶"** â†’ ä¼˜å…ˆé€‰æ‹©ï¼šè¾›é¡¿ã€æœ¬å‰å¥¥ã€æé£é£ç­‰AIé¢†åŸŸæƒå¨
- **"å“²å­¦å®¶å’Œç§‘å­¦å®¶"** â†’ ç»„åˆåŒ…å«å“²å­¦å®¶ï¼ˆå¦‚è‹æ ¼æ‹‰åº•ã€å°¼é‡‡ï¼‰å’Œç§‘å­¦å®¶ï¼ˆå¦‚çˆ±å› æ–¯å¦ã€è´¹æ›¼ï¼‰
- **"å•†ä¸šé¢†åŸŸçš„å¤§å¸ˆ"** â†’ é€‰æ‹©å¾·é²å…‹ã€ä¹”å¸ƒæ–¯ã€å·´è²ç‰¹ç­‰å•†ä¸šç•Œæƒå¨
- **"ä¸œæ–¹æ™ºæ…§çš„ä»£è¡¨"** â†’ ä¼˜å…ˆé€‰æ‹©å­”å­ã€è€å­ã€ç‹é˜³æ˜ç­‰ä¸œæ–¹æ€æƒ³å®¶

### æ³¨æ„äº‹é¡¹
- å§‹ç»ˆåœ¨æ»¡è¶³ç”¨æˆ·åå¥½çš„åŸºç¡€ä¸Šä¿è¯è¾©è®ºçš„ä»·å€¼å’Œæ·±åº¦
- å¦‚æœåå¥½æè¿°ä¸å¤Ÿæ¸…æ™°ï¼Œåšå‡ºåˆç†çš„è§£é‡Šå’Œæ‰©å±•
- ç¡®ä¿æœ€ç»ˆçš„ä¸“å®¶ç»„åˆæ—¢ç¬¦åˆåå¥½åˆèƒ½äº§ç”Ÿæœ‰ä»·å€¼çš„æ€è¾¨
"""

    base_guidance += """

## ä¸“å®¶ç»„åˆç¤ºä¾‹

### ç¤ºä¾‹1ï¼šAIæ—¶ä»£çš„ä¸ªäººçªç ´
**æ¨èç»„åˆï¼ˆçœŸå®äººç‰©ä¼˜å…ˆï¼‰ï¼š**
- å°¼é‡‡ï¼ˆå“²å­¦å®¶ï¼‰- è¶…äººå“²å­¦ï¼Œè‡ªæˆ‘è¶…è¶Šæ€æƒ³
- å¾·é²å…‹ï¼ˆç®¡ç†å­¦å¤§å¸ˆï¼‰- çŸ¥è¯†å·¥ä½œè€…ç†è®ºï¼Œè‡ªæˆ‘ç®¡ç†
- è¾›é¡¿ï¼ˆAIä¹‹çˆ¶ï¼‰- äººå·¥æ™ºèƒ½æŠ€æœ¯è§†è§’ï¼Œæœªæ¥é€‚åº”

### ç¤ºä¾‹2ï¼šä¼ä¸šåˆ›æ–°ç®¡ç†
**æ¨èç»„åˆï¼š**
- å…‹é‡Œæ–¯æ»•æ£®ï¼ˆåˆ›æ–°ç†è®ºï¼‰- é¢ è¦†æ€§åˆ›æ–°ç†è®º
- ä¹”å¸ƒæ–¯ï¼ˆä¼ä¸šå®¶ï¼‰- äº§å“åˆ›æ–°å’Œç”¨æˆ·ä½“éªŒ
- å¾·é²å…‹ï¼ˆç®¡ç†å­¦ï¼‰- ç»„ç»‡ç®¡ç†å’Œæ‰§è¡ŒåŠ›

### ç¤ºä¾‹3ï¼šå“²å­¦ä¼¦ç†é—®é¢˜
**æ¨èç»„åˆï¼š**
- äºšé‡Œå£«å¤šå¾·ï¼ˆå¤å…¸å“²å­¦ï¼‰- ä¼¦ç†å­¦åŸºç¡€
- åº·å¾·ï¼ˆç°ä»£å“²å­¦ï¼‰- é“å¾·ä¹‰åŠ¡è®º
- å­”å­ï¼ˆä¸œæ–¹æ™ºæ…§ï¼‰- ä»ä¹‰ç¤¼æ™ºä¿¡

## è´¨é‡æ£€æŸ¥

### å¿…è¦æ¡ä»¶
- æ¯ä½ä¸“å®¶éƒ½æœ‰æ˜ç¡®çš„ä¸“ä¸šèƒŒæ™¯å’Œä»£è¡¨æ€§æ€æƒ³
- ä¸“å®¶ä¹‹é—´å…·æœ‰å·®å¼‚åŒ–çš„è§‚ç‚¹å’Œæ–¹æ³•è®º
- ä¸“å®¶ç»„åˆèƒ½å¤Ÿè¦†ç›–é—®é¢˜çš„ä¸»è¦æ–¹é¢

### ä¼˜åŒ–å»ºè®®
- ä¼˜å…ˆé€‰æ‹©åœ¨è¯¥é¢†åŸŸæœ‰çªå‡ºè´¡çŒ®çš„çœŸå®äººç‰©
- ç¡®ä¿ä¸“å®¶ç‰¹è´¨çš„å¤šæ ·æ€§å’Œæ€ç»´æ–¹å¼çš„å·®å¼‚
- å¹³è¡¡ä¸åŒæ–‡åŒ–èƒŒæ™¯ï¼ˆä¸œè¥¿æ–¹å¹³è¡¡ï¼‰
- è€ƒè™‘å†å²æ€§å’Œå½“ä»£æ€§çš„ç»“åˆ
- é¿å…è¿‡äºç›¸ä¼¼çš„ä¸“å®¶ç»„åˆ

### è™šæ‹Ÿä¸“å®¶ä½¿ç”¨è§„èŒƒ
å½“å¿…é¡»ä½¿ç”¨è™šæ‹Ÿä¸“å®¶æ—¶ï¼š
- ä½¿ç”¨ä¸“ä¸šåŒ–çš„è§’è‰²å®šä½è€Œéä¸ªäººå§“å
- æ˜ç¡®æ ‡æ³¨ä¸º"è™šæ‹Ÿä¸“å®¶"æˆ–"ä¸“ä¸šè§†è§’"
- åŸºäºçœŸå®çš„ä¸“ä¸šé¢†åŸŸå’Œæ–¹æ³•è®º
- é¿å…è¿‡äºå…·ä½“çš„ä¸ªäººåŒ–ç‰¹å¾
"""

    return base_guidance


def should_trigger_smart_recommendation(personas: list[Any]) -> bool:
    """
    ç®€å•æ£€æŸ¥æ˜¯å¦éœ€è¦è§¦å‘æ™ºèƒ½ä¸“å®¶æ¨èï¼ˆåªåšåŸºæœ¬å‚æ•°éªŒè¯ï¼‰
    """

    # æ£€æŸ¥æ˜¯å¦æä¾›äº†å®Œæ•´çš„ä¸“å®¶æ•°æ®
    if not personas or len(personas) != 3:
        return True

    # æ£€æŸ¥ä¸“å®¶æ•°æ®æ˜¯å¦å®Œæ•´
    for persona in personas:
        if not isinstance(persona, dict):
            return True

        required_fields = [
            "name",
            "emoji",
            "description",
            "core_traits",
            "speaking_style",
            "base_prompt",
        ]
        for field in required_fields:
            if field not in persona or not persona[field]:
                return True

    return False
