[tox]
envlist =
    py{37, 38, 39, 310}
    lint
    typing
    release
skipdist = true
skip_missing_interpreters = true

[testenv]
description = run the tests with pytest under {basepython}
deps =
    pytest
    pytest-cov
setenv =
    PIP_INDEX_URL=https://pypi.tuna.tsinghua.edu.cn/simple
    # PIP_EXTRA_INDEX_URL=https://test.solution.s:Password@qwe123@artifactory.nevint.com/artifactory/api/pypi/ds-niotest-python-local/simple
commands =
    pytest --cov --cov-report html:{envdir}/cov_html

[testenv:lint]
description = format the code base to adhere to our styles, and complain about what we cannot do automatically
basepython = python
skip_install = true
deps =
    pre-commit>=2.16
    importlib-metadata<5.0
commands =
    pre-commit run --all-files --show-diff-on-failure {posargs}

[testenv:typing]
description = static type checker
basepython = python
skip_install = true
deps =
    mypy
commands =
    mypy --ignore-missing-imports {toxinidir}/someip_py

[testenv:release]
description = release package according to twine
basepython = python
deps =
    pycryptodome
    twine
passenv =
    TWINE_USERNAME
    TWINE_PASSWORD
    TWINE_REPOSITORY_URL
setenv =
    # TWINE_USERNAME = {env:TWINE_USERNAME:pip-read}
    # TWINE_PASSWORD = {env:TWINE_PASSWORD:123456}
    # TWINE_REPOSITORY_URL = {env:TWINE_REPOSITORY_URL:https://devops-maven.zeekrlife.com/repository/pypi/}
    TWINE_USERNAME = {env:TWINE_USERNAME:__token__}
    TWINE_PASSWORD = {env:TWINE_PASSWORD:pypi-AgEIcHlwaS5vcmcCJDkzMjMwMWZkLWJiYWQtNDRmNS1iNWRlLWZlMzNhZGFhMjE3YwACKlszLCI4ZjI3YTM3My0xNTc1LTQ1ZGQtOGYwMC1hZjE5ZGEzM2MzYjYiXQAABiDFn3f5TANrXWgfCmlc9MHP4PDHmeWOs9bwCy3w4u3v1A}
commands =
    python -c "import shutil; shutil.rmtree('dist', ignore_errors=True)"
    python setup.py bdist_wheel
    python -m twine upload dist/*

[flake8]
max-line-length = 120
per-file-ignores =
    */v1.wsgi: F401
    */pb/*: E501, E712, F821
    tests/*: E501
extend-ignore =
    ; no newline at end of file
    W292, W605
    ; import *
    F403, F405
    ; whitespace before ':'
    E203, E731, E741
