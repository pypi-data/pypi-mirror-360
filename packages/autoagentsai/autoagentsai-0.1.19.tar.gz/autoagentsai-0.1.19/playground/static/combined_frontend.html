<!DOCTYPE html>
<html>
<head>
    <title>AutoAgents AI - 终极流式演示</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f7f7f7; }
        h1 { text-align: center; color: #333; }
        .chat-container { border: 1px solid #ddd; height: 500px; overflow-y: auto; padding: 20px; margin-bottom: 20px; background-color: white; border-radius: 8px; }
        .message { margin-bottom: 15px; display: flex; flex-direction: column; }
        .user-message .content { background: #007bff; color: white; padding: 10px 15px; border-radius: 18px; align-self: flex-end; max-width: 80%; }
        .ai-message .content { background: #e9e9eb; color: #333; padding: 10px 15px; border-radius: 18px; align-self: flex-start; max-width: 80%; white-space: pre-wrap; position: relative; }
        .ai-message .content .cursor { display: inline-block; width: 10px; height: 1.2em; background-color: #333; animation: blink 1s step-end infinite; }
        .reasoning-container { background: #f0f8ff; border-left: 3px solid #4a90e2; margin: 5px 0; padding: 8px 12px; border-radius: 5px; font-size: 0.9em; color: #555; }
        .reasoning-content { font-style: italic; }
        .reasoning-label { font-weight: bold; color: #4a90e2; margin-bottom: 5px; }
        @keyframes blink { 50% { opacity: 0; } }
        .input-area { display: flex; flex-direction: column; gap: 10px; border-top: 1px solid #ddd; padding-top: 20px; }
        .input-row { display: flex; gap: 10px; }
        .input-row input[type="text"] { flex: 1; padding: 12px; border: 1px solid #ccc; border-radius: 8px; }
        .input-row button { padding: 12px 25px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
        .input-row button:disabled { background: #aaa; cursor: not-allowed; }
        .input-row button:hover:not(:disabled) { background: #0056b3; }
    </style>
</head>
<body>
    <h1>多气泡 + 打字机 + 推理过程</h1>
    
    <div id="chat" class="chat-container"></div>
    
    <form id="chatForm" class="input-area">
        <div class="input-row">
            <input type="text" name="prompt" id="prompt" placeholder="输入您的问题..." autocomplete="off" />
            <button id="sendBtn" type="submit">发送</button>
        </div>
        <input type="file" name="file" id="file" />
    </form>

    <script>
        const chatContainer = document.getElementById('chat');
        const chatForm = document.getElementById('chatForm');
        const sendBtn = document.getElementById('sendBtn');
        const promptInput = document.getElementById('prompt');
        const fileInput = document.getElementById('file');

        function appendUserMessage(text) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message user-message';
            const contentDiv = document.createElement('div');
            contentDiv.className = 'content';
            contentDiv.textContent = text;
            msgDiv.appendChild(contentDiv);
            chatContainer.appendChild(msgDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        chatForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const prompt = promptInput.value.trim();
            if (!prompt) return;

            setLoading(true);
            appendUserMessage(prompt);

            let currentBubble = null;
            let cursor = null;
            let currentReasoningContainer = null;

            try {
                const response = await fetch('/combined-chat', {
                    method: 'POST',
                    body: new FormData(chatForm),
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const event = JSON.parse(line.substring(6));
                                
                                if (event.type === 'start_bubble') {
                                    // 结束上一个气泡的光标
                                    if (cursor) cursor.remove();
                                    
                                    const msgDiv = document.createElement('div');
                                    msgDiv.className = 'message ai-message';
                                    currentBubble = document.createElement('div');
                                    currentBubble.className = 'content';
                                    
                                    // 添加闪烁光标
                                    cursor = document.createElement('span');
                                    cursor.className = 'cursor';
                                    currentBubble.appendChild(cursor);
                                    
                                    msgDiv.appendChild(currentBubble);
                                    chatContainer.appendChild(msgDiv);
                                    
                                    // 重置推理容器
                                    currentReasoningContainer = null;
                                }
                                else if (event.type === 'reasoning_token') {
                                    // 处理推理内容
                                    if (!currentReasoningContainer) {
                                        currentReasoningContainer = document.createElement('div');
                                        currentReasoningContainer.className = 'reasoning-container';
                                        
                                        const label = document.createElement('div');
                                        label.className = 'reasoning-label';
                                        label.textContent = '🤔 AI 推理过程：';
                                        currentReasoningContainer.appendChild(label);
                                        
                                        const reasoningContent = document.createElement('div');
                                        reasoningContent.className = 'reasoning-content';
                                        currentReasoningContainer.appendChild(reasoningContent);
                                        
                                        chatContainer.appendChild(currentReasoningContainer);
                                    }
                                    
                                    const reasoningContent = currentReasoningContainer.querySelector('.reasoning-content');
                                    reasoningContent.textContent += event.content;
                                }
                                else if (event.type === 'token' && currentBubble) {
                                    // 在光标前插入文本
                                    const textNode = document.createTextNode(event.content);
                                    currentBubble.insertBefore(textNode, cursor);
                                }
                                else if (event.type === 'end_bubble') {
                                    if (cursor) cursor.remove();
                                    currentBubble = null;
                                }
                                else if (event.type === 'finish') {
                                    if (cursor) cursor.remove();
                                    setLoading(false);
                                }
                                chatContainer.scrollTop = chatContainer.scrollHeight;
                            } catch(e) { /* 忽略不完整的 JSON */ }
                        }
                    }
                }
            } catch (error) {
                console.error('流式传输错误:', error);
                if (currentBubble) {
                    currentBubble.textContent += "\n\n[出错了，请检查后端或网络]";
                }
                setLoading(false);
            }
        });

        function setLoading(isLoading) {
            promptInput.disabled = isLoading;
            fileInput.disabled = isLoading;
            sendBtn.disabled = isLoading;
            if (isLoading) {
                promptInput.value = "";
                fileInput.value = "";
            }
        }
    </script>
</body>
</html> 