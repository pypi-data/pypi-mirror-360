<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tallyfy MCP</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .connection-status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .chat-container {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #fafafa;
            border-radius: 5px;
        }
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
            max-width: 80%;
        }
        .user-message {
            background-color: #007bff;
            color: white;
            margin-left: auto;
            text-align: right;
        }
        .assistant-message {
            background-color: #e9ecef;
            color: #333;
        }
        .system-message {
            background-color: #fff3cd;
            color: #856404;
            text-align: center;
            max-width: 100%;
        }
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            max-width: 100%;
        }
        .input-container {
            display: flex;
            gap: 10px;
        }
        .input-field {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        .send-button, .clear-button {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        .send-button {
            background-color: #007bff;
            color: white;
        }
        .send-button:hover {
            background-color: #0056b3;
        }
        .clear-button {
            background-color: #6c757d;
            color: white;
        }
        .clear-button:hover {
            background-color: #545b62;
        }
        .controls {
            margin-bottom: 20px;
            text-align: center;
        }
        .control-button {
            padding: 8px 16px;
            margin: 0 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .connect-button {
            background-color: #28a745;
            color: white;
        }
        .disconnect-button {
            background-color: #dc3545;
            color: white;
        }
        .auth-section {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .auth-header {
            font-weight: bold;
            color: #495057;
            margin-bottom: 15px;
            text-align: center;
        }
        .auth-form {
            display: grid;
            gap: 10px;
            max-width: 500px;
            margin: 0 auto;
        }
        .auth-input {
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 14px;
        }
        .auth-button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        .auth-button:hover {
            background-color: #0056b3;
        }
        .auth-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .auth-status {
            text-align: center;
            font-weight: bold;
            margin-top: 10px;
        }
        .authenticated {
            color: #28a745;
        }
        .not-authenticated {
            color: #dc3545;
        }
        
        /* Styles for rendered HTML content in assistant messages */
        .assistant-message h1, .assistant-message h2, .assistant-message h3,
        .assistant-message h4, .assistant-message h5, .assistant-message h6 {
            margin: 15px 0 10px 0;
            color: #333;
        }
        
        .assistant-message h1 { font-size: 1.5em; }
        .assistant-message h2 { font-size: 1.3em; }
        .assistant-message h3 { font-size: 1.2em; }
        .assistant-message h4 { font-size: 1.1em; }
        
        .assistant-message p {
            margin: 8px 0;
            line-height: 1.4;
        }
        
        .assistant-message ul, .assistant-message ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .assistant-message li {
            margin: 4px 0;
        }
        
        .assistant-message code {
            background-color: #f1f3f4;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
        }
        
        .assistant-message pre {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 12px;
            overflow-x: auto;
            margin: 10px 0;
        }
        
        .assistant-message pre code {
            background-color: transparent;
            padding: 0;
        }
        
        .assistant-message table {
            border-collapse: collapse;
            width: 100%;
            margin: 10px 0;
            font-size: 0.9em;
        }
        
        .assistant-message th, .assistant-message td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        .assistant-message th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        
        .assistant-message blockquote {
            border-left: 4px solid #007bff;
            margin: 10px 0;
            padding: 10px 15px;
            background-color: #f8f9fa;
            font-style: italic;
        }
        
        .assistant-message a {
            color: #007bff;
            text-decoration: none;
        }
        
        .assistant-message a:hover {
            text-decoration: underline;
        }
        
        .assistant-message strong {
            font-weight: bold;
        }
        
        .assistant-message em {
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚úÖ Tallyfy MCP Client</h1>
        </div>

        <div class="controls">
            <button id="connectBtn" class="control-button connect-button">Connect</button>
        </div>

        <div id="connectionStatus" class="connection-status disconnected">
            Disconnected
        </div>

        <div id="authSection" class="auth-section" style="display: none;">
            <div class="auth-header">üîê Authentication Required</div>
            <div class="auth-form">
                <input type="text" id="apiKeyInput" class="auth-input" placeholder="Enter your Tallyfy API Key">
                <input type="text" id="orgIdInput" class="auth-input" placeholder="Enter your Organization ID">
                <button id="authBtn" class="auth-button">Authenticate</button>
                <div id="authStatus" class="auth-status not-authenticated">Not authenticated</div>
            </div>
        </div>

        <div id="chatContainer" class="chat-container">
            <div class="message system-message">
                Welcome to Tallyfy MCP! Connecting to server...
            </div>
        </div>

        <div class="input-container">
            <input type="text" id="messageInput" class="input-field" placeholder="Type your message here..." disabled>
            <button id="sendBtn" class="send-button" disabled>Send</button>
            <button id="clearBtn" class="clear-button" disabled>Clear</button>
        </div>
    </div>

    <script>
        class MCPWebSocketClient {
            constructor() {
                this.socket = null;
                this.sessionId = null;
                this.isConnected = false;
                this.isAuthenticated = false;
                
                this.initializeEventListeners();
            }

            initializeEventListeners() {
                // UI Elements
                this.connectBtn = document.getElementById('connectBtn');
                this.connectionStatus = document.getElementById('connectionStatus');
                this.authSection = document.getElementById('authSection');
                this.apiKeyInput = document.getElementById('apiKeyInput');
                this.orgIdInput = document.getElementById('orgIdInput');
                this.authBtn = document.getElementById('authBtn');
                this.authStatus = document.getElementById('authStatus');
                this.chatContainer = document.getElementById('chatContainer');
                this.messageInput = document.getElementById('messageInput');
                this.sendBtn = document.getElementById('sendBtn');
                this.clearBtn = document.getElementById('clearBtn');

                // Event Listeners
                this.connectBtn.addEventListener('click', () => this.handleConnectionToggle());
                
                // Auto-connect on page load
                this.autoConnect();
                this.authBtn.addEventListener('click', () => this.authenticate());
                this.sendBtn.addEventListener('click', () => this.sendMessage());
                this.clearBtn.addEventListener('click', () => this.clearConversation());
                
                this.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                this.apiKeyInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.orgIdInput.focus();
                    }
                });

                this.orgIdInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.authenticate();
                    }
                });
            }

            autoConnect() {
                // Auto-connect to the fixed WebSocket URL
                this.connect('ws://localhost:9001');
            }

            connect(url = null) {
                const serverUrl = url || 'ws://localhost:9001';
                
                // Reset authentication state on new connection
                this.isAuthenticated = false;
                this.sessionId = null;

                try {
                    this.socket = new WebSocket(serverUrl);
                    
                    this.socket.onopen = () => {
                        this.isConnected = true;
                        this.updateConnectionStatus('Connected', true);
                        this.updateButtonStates();
                        this.addSystemMessage('Connected to server');
                    };

                    this.socket.onmessage = (event) => {
                        this.handleMessage(JSON.parse(event.data));
                    };

                    this.socket.onclose = () => {
                        this.isConnected = false;
                        this.updateConnectionStatus('Disconnected', false);
                        this.updateButtonStates();
                        this.addSystemMessage('Disconnected from server');
                    };

                    this.socket.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        this.addErrorMessage('WebSocket connection error');
                    };

                } catch (error) {
                    console.error('Connection error:', error);
                    this.addErrorMessage('Failed to connect to server');
                }
            }

            handleConnectionToggle() {
                if (this.isConnected) {
                    this.disconnect();
                } else {
                    this.connect();
                }
            }

            disconnect() {
                if (this.socket) {
                    this.socket.close();
                }
            }

            authenticate() {
                const apiKey = this.apiKeyInput.value.trim();
                const orgId = this.orgIdInput.value.trim();

                if (!apiKey || !orgId) {
                    alert('Please enter both API key and organization ID');
                    return;
                }

                if (!this.isConnected) {
                    alert('Please connect to the server first');
                    return;
                }

                // Send authentication data
                this.socket.send(JSON.stringify({
                    type: 'auth',
                    api_key: apiKey,
                    org_id: orgId
                }));

                this.authBtn.disabled = true;
                this.authBtn.textContent = 'Authenticating...';
            }

            sendMessage() {
                const message = this.messageInput.value.trim();
                if (!message || !this.isConnected) return;

                // Add user message to chat
                this.addUserMessage(message);
                
                // Send to server
                this.socket.send(JSON.stringify({
                    type: 'query',
                    content: message
                }));

                // Clear input
                this.messageInput.value = '';
            }

            clearConversation() {
                if (!this.isConnected) return;
                
                this.socket.send(JSON.stringify({
                    type: 'query',
                    content: 'clear'
                }));
            }

            clearChatUI() {
                // Clear all messages from the chat container
                this.chatContainer.innerHTML = '';
                
                // Add a system message to indicate conversation was cleared
                this.addSystemMessage('‚ú® Conversation history cleared!');
            }

            handleMessage(data) {
                switch (data.type) {
                    case 'connection_established':
                        this.sessionId = data.session_id;
                        this.addSystemMessage(`${data.message} (Session: ${data.session_id})`);
                        if (!data.authenticated) {
                            this.showAuthSection();
                        }
                        break;
                    
                    case 'auth_success':
                        this.isAuthenticated = true;
                        this.addSystemMessage(data.message);
                        this.updateAuthStatus('‚úÖ Authenticated', true);
                        this.hideAuthSection();
                        this.updateButtonStates();
                        break;
                    
                    case 'auth_error':
                        this.addErrorMessage(`Authentication failed: ${data.message}`);
                        this.updateAuthStatus('‚ùå Authentication failed', false);
                        this.authBtn.disabled = false;
                        this.authBtn.textContent = 'Authenticate';
                        break;
                    
                    case 'response':
                        this.addAssistantMessage(data.message);
                        break;
                    
                    case 'error':
                        this.addErrorMessage(data.message);
                        break;
                    
                    case 'info':
                        // Check if this is a conversation cleared message
                        if (data.message.includes('Conversation history cleared')) {
                            this.clearChatUI();
                        } else {
                            this.addSystemMessage(data.message);
                        }
                        break;
                    
                    case 'processing':
                        this.addSystemMessage(data.message);
                        break;
                    
                    case 'disconnect':
                        this.addSystemMessage(data.message);
                        break;
                    
                    case 'pong':
                        console.log('Pong received');
                        break;
                    
                    default:
                        console.log('Unknown message type:', data);
                }
            }

            showAuthSection() {
                this.authSection.style.display = 'block';
                this.apiKeyInput.focus();
            }

            hideAuthSection() {
                this.authSection.style.display = 'none';
            }

            updateAuthStatus(message, isAuthenticated) {
                this.authStatus.textContent = message;
                this.authStatus.className = `auth-status ${isAuthenticated ? 'authenticated' : 'not-authenticated'}`;
            }

            addUserMessage(text) {
                this.addMessage(text, 'user-message');
            }

            addAssistantMessage(text) {
                this.addMessage(text, 'assistant-message');
            }

            addSystemMessage(text) {
                this.addMessage(text, 'system-message');
            }

            addErrorMessage(text) {
                this.addMessage(text, 'error-message');
            }

            addMessage(text, className) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${className}`;
                
                // For assistant messages, render HTML; for others, use text content for security
                if (className === 'assistant-message') {
                    messageDiv.innerHTML = text;
                } else {
                    messageDiv.textContent = text;
                }
                
                this.chatContainer.appendChild(messageDiv);
                this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
            }

            updateConnectionStatus(status, isConnected) {
                this.connectionStatus.textContent = status;
                this.connectionStatus.className = `connection-status ${isConnected ? 'connected' : 'disconnected'}`;
            }

            updateButtonStates() {
                if (this.isConnected) {
                    this.connectBtn.textContent = 'Disconnect';
                    this.connectBtn.className = 'control-button disconnect-button';
                } else {
                    this.connectBtn.textContent = 'Connect';
                    this.connectBtn.className = 'control-button connect-button';
                }
                
                this.messageInput.disabled = !this.isConnected;
                this.sendBtn.disabled = !this.isConnected;
                this.clearBtn.disabled = !this.isConnected;
                
                if (this.isConnected) {
                    this.messageInput.focus();
                }
            }
        }

        // Initialize the client when the page loads
        window.addEventListener('DOMContentLoaded', () => {
            new MCPWebSocketClient();
        });
    </script>
</body>
</html>