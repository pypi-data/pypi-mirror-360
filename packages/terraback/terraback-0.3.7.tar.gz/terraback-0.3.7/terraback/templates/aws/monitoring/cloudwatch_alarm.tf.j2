{% for alarm in resources -%}
{%  if alarm.get('AlarmType') == 'CompositeAlarm' %}
resource "aws_cloudwatch_composite_alarm" "alarm_{{ alarm.name_sanitized }}" {
  alarm_name        = "{{ alarm.AlarmName }}"
  alarm_description = "{{ alarm.get('AlarmDescription', '') | replace('"', '\\"') }}"
  alarm_rule        = "{{ alarm.AlarmRule | replace('"', '\\"') }}"

  {%  if alarm.get('ActionsEnabled') is defined %}
  actions_enabled = {{ alarm.ActionsEnabled | lower }}
  {%  endif -%}

  {%  if alarm.get('AlarmActions') %}
  alarm_actions = [
    {%- for action in alarm.AlarmActions %}
    "{{ action }}"{{ "," if not loop.last }}
    {%- endfor %}
  ]
  {%  endif -%}

  {%  if alarm.get('OKActions') %}
  ok_actions = [
    {%- for action in alarm.OKActions %}
    "{{ action }}"{{ "," if not loop.last }}
    {%- endfor %}
  ]
  {%  endif -%}

  {%  if alarm.get('InsufficientDataActions') %}
  insufficient_data_actions = [
    {%- for action in alarm.InsufficientDataActions %}
    "{{ action }}"{{ "," if not loop.last }}
    {%- endfor %}
  ]
  {%  endif -%}

  {%  if alarm.get('Tags') %}
  tags = {
    {%- for tag in alarm.get('Tags', []) %}
    "{{ tag.Key }}" = "{{ tag.Value | replace('"', '\\"') }}"{{ "," if not loop.last }}
    {%- endfor %}
  }
  {%  endif -%}
}
{%- else %}
resource "aws_cloudwatch_metric_alarm" "alarm_{{ alarm.name_sanitized }}" {
  alarm_name          = "{{ alarm.AlarmName }}"
  alarm_description   = "{{ alarm.get('AlarmDescription', '') | replace('"', '\\"') }}"
  
  {%  if alarm.get('MetricName') %}
  metric_name         = "{{ alarm.MetricName }}"
  {%  endif -%}
  {%  if alarm.get('Namespace') %}
  namespace           = "{{ alarm.Namespace }}"
  {%  endif -%}
  {%  if alarm.get('Statistic') %}
  statistic           = "{{ alarm.Statistic }}"
  {%  endif -%}
  {%  if alarm.get('ExtendedStatistic') %}
  extended_statistic  = "{{ alarm.ExtendedStatistic }}"
  {%  endif -%}
  
  period              = {{ alarm.get('Period', 300) }}
  evaluation_periods  = {{ alarm.get('EvaluationPeriods', 1) }}
  {%  if alarm.get('Threshold') is defined and alarm.Threshold is not none %}
  threshold           = {{ alarm.Threshold }}
  {%  endif -%}
  comparison_operator = "{{ alarm.get('ComparisonOperator', 'GreaterThanThreshold') }}"

  {%  if alarm.get('ActionsEnabled') is defined %}
  actions_enabled = {{ alarm.ActionsEnabled | lower }}
  {%  endif -%}

  {%  if alarm.get('AlarmActions') %}
  alarm_actions = [
    {%- for action in alarm.AlarmActions %}
    "{{ action }}"{{ "," if not loop.last }}
    {%- endfor %}
  ]
  {%  endif -%}

  {%  if alarm.get('OKActions') %}
  ok_actions = [
    {%- for action in alarm.OKActions %}
    "{{ action }}"{{ "," if not loop.last }}
    {%- endfor %}
  ]
  {%  endif -%}

  {%  if alarm.get('InsufficientDataActions') %}
  insufficient_data_actions = [
    {%- for action in alarm.InsufficientDataActions %}
    "{{ action }}"{{ "," if not loop.last }}
    {%- endfor %}
  ]
  {%  endif -%}

  {%  if alarm.get('Dimensions') %}
  dimensions = {
    {%- for dimension in alarm.Dimensions %}
    "{{ dimension.Name }}" = "{{ dimension.Value }}"{{ "," if not loop.last }}
    {%- endfor %}
  }
  {%  endif -%}

  {%  if alarm.get('Unit') %}
  unit = "{{ alarm.Unit }}"
  {%  endif -%}

  {%  if alarm.get('DatapointsToAlarm') is defined and alarm.DatapointsToAlarm is not none %}
  datapoints_to_alarm = {{ alarm.DatapointsToAlarm }}
  {%  endif -%}

  {%  if alarm.get('TreatMissingData') %}
  treat_missing_data = "{{ alarm.TreatMissingData }}"
  {%  endif -%}

  {%  if alarm.get('EvaluateLowSampleCountPercentile') %}
  evaluate_low_sample_count_percentiles = "{{ alarm.EvaluateLowSampleCountPercentile }}"
  {%  endif -%}

  {%  if alarm.get('Metrics') %}
  {%- for metric in alarm.Metrics %}
  metric_query {
    id          = "{{ metric.Id }}"
    {%  if metric.get('Expression') %}
    expression  = "{{ metric.Expression | replace('"', '\\"') }}"
    {%  endif -%}
    {%  if metric.get('Label') %}
    label       = "{{ metric.Label | replace('"', '\\"') }}"
    {%  endif -%}
    {%  if metric.get('ReturnData') is defined %}
    return_data = {{ metric.ReturnData | lower }}
    {%  endif -%}
    
    {%  if metric.get('MetricStat') %}
    metric {
      metric_name = "{{ metric.MetricStat.Metric.MetricName }}"
      namespace   = "{{ metric.MetricStat.Metric.Namespace }}"
      period      = {{ metric.MetricStat.Period }}
      stat        = "{{ metric.MetricStat.Stat }}"
      {%  if metric.MetricStat.get('Unit') %}
      unit        = "{{ metric.MetricStat.Unit }}"
      {%  endif -%}
      
      {%  if metric.MetricStat.Metric.get('Dimensions') %}
      dimensions = {
        {%- for dim in metric.MetricStat.Metric.Dimensions %}
        "{{ dim.Name }}" = "{{ dim.Value }}"{{ "," if not loop.last }}
        {%- endfor %}
      }
      {%  endif -%}
    }
    {%  endif -%}
  }
  {%- endfor %}
  {%  endif -%}

  {%  if alarm.get('Tags') %}
  tags = {
    {%- for tag in alarm.get('Tags', []) %}
    "{{ tag.Key }}" = "{{ tag.Value | replace('"', '\\"') }}"{{ "," if not loop.last }}
    {%- endfor %}
  }
  {%  endif -%}
}
{%  endif -%}

{% if not loop.last %}

{% endif -%}
{%- endfor %}