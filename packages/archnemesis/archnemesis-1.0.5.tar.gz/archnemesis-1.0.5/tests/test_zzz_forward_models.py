import pytest  
import archnemesis as ans
import numpy as np
import os
curr = os.getcwd()

def test_thermal_emission_cirs():  
    '''
    Jupiter thermal emission test against NEMESIS
    '''
    test_dir = os.path.join(ans.archnemesis_path(), 'tests/files/Jupiter_CIRS_nadir_thermal_emission/')
    os.chdir(test_dir) #Changing directory to read files
    runname = 'cirstest'
    
    #Reading the input files
    Atmosphere,Measurement,Spectroscopy,Scatter,Stellar,Surface,CIA,Layer,Variables,Retrieval = ans.Files.read_input_files(runname)
    
    #Calculating forward model with CIRSrad
    ForwardModel = ans.ForwardModel_0(runname=runname, Atmosphere=Atmosphere,Surface=Surface,Measurement=Measurement,Spectroscopy=Spectroscopy,Stellar=Stellar,Scatter=Scatter,CIA=CIA,Layer=Layer,Variables=Variables)
    SPECONV_cirsrad = ForwardModel.nemesisfm()
    calculation_cirsrad = SPECONV_cirsrad[:,0]
    
    #Calculating forward model with CIRSradg
    SPECONV_cirsradg,_ = ForwardModel.nemesisfmg()
    calculation_cirsradg = SPECONV_cirsradg[:,0]
    os.chdir(curr) #Changing directory back to the original
    
    expected_nemesis = np.array([4.8584261e-09, 7.3546157e-09, 1.1448862e-08, 1.6160637e-08, 2.1053524e-08,
                                2.5728575e-08, 2.9602468e-08, 3.2811268e-08, 4.3521572e-08, 5.5772129e-08,
                                6.5849976e-08, 7.3240631e-08, 8.3390190e-08, 9.2134087e-08, 1.0044071e-07,
                                1.0678105e-07, 1.1343881e-07, 1.1549196e-07, 1.2531892e-07, 1.4620917e-07,
                                1.6264473e-07, 1.7962228e-07, 1.9288992e-07, 2.0416275e-07, 2.1074971e-07,
                                2.2027789e-07, 2.2266154e-07, 2.2305901e-07, 2.4031033e-07, 2.6767789e-07,
                                2.9259265e-07, 3.1068597e-07, 3.2589871e-07, 3.3453671e-07, 3.4601343e-07,
                                3.5169019e-07, 3.4915579e-07, 3.4144742e-07, 3.6189087e-07, 3.9845914e-07,
                                4.2636136e-07, 4.4908469e-07, 4.6496048e-07, 4.8008325e-07, 4.8607019e-07,
                                4.8612775e-07, 4.7288797e-07, 4.5949658e-07, 4.9488187e-07, 5.4081171e-07,
                                5.7139917e-07, 5.9743573e-07, 6.1747736e-07, 6.3028912e-07, 6.3479559e-07,
                                6.2755280e-07, 5.9436615e-07, 5.7073480e-07, 6.2801385e-07, 6.8389581e-07,
                                7.2138861e-07, 7.4936548e-07, 7.6929932e-07, 7.8037451e-07, 7.8282648e-07,
                                7.6146552e-07, 6.9230811e-07, 6.7543353e-07, 7.6866937e-07, 8.3855658e-07,
                                8.7873480e-07, 9.0911798e-07, 9.2920862e-07, 9.3920532e-07, 9.3839355e-07,
                                8.9851105e-07, 7.8122192e-07, 7.8696436e-07, 9.2957825e-07, 1.0037038e-06,
                                1.0499105e-06, 1.0827148e-06, 1.1033911e-06, 1.1090631e-06, 1.1063834e-06,
                                1.0004811e-06, 8.4869373e-07, 9.2497845e-07, 1.1164567e-06, 1.1966298e-06,
                                1.2438824e-06, 1.2778672e-06, 1.2954698e-06, 1.2930934e-06, 1.2831893e-06,
                                1.0706979e-06, 9.5264032e-07, 1.0764868e-06, 1.3135985e-06, 1.3970815e-06,
                                1.4377687e-06, 1.4615624e-06, 1.4683627e-06, 1.4729186e-06, 1.3863530e-06,
                                1.1112964e-06, 1.0892354e-06, 1.2808145e-06, 1.5100726e-06, 1.5500964e-06,
                                1.5637694e-06, 1.5710072e-06, 1.5696403e-06, 1.5613228e-06, 1.3672264e-06,
                                1.2307899e-06, 1.2651921e-06, 1.4578094e-06, 1.5720677e-06, 1.5743357e-06,
                                1.5702667e-06, 1.5635206e-06, 1.5542504e-06, 1.4899187e-06, 1.3873461e-06,
                                1.3215043e-06, 1.3458383e-06, 1.4491620e-06, 1.4914265e-06, 1.4772347e-06,
                                1.4617134e-06, 1.4449102e-06, 1.4224144e-06, 1.3886283e-06, 1.3546263e-06,
                                1.3173374e-06, 1.3182119e-06, 1.3266578e-06, 1.3092109e-06, 1.2875592e-06,
                                1.2651860e-06, 1.2420231e-06, 1.2180204e-06, 1.1936686e-06, 1.1677655e-06,
                                1.1430958e-06, 1.1220846e-06, 1.0999083e-06, 1.0761125e-06, 1.0523517e-06,
                                1.0287583e-06, 1.0054186e-06, 9.8237390e-07, 9.5967468e-07, 9.3741150e-07,
                                9.1562036e-07, 8.9442218e-07, 8.7381378e-07, 8.5369598e-07, 8.3420624e-07,
                                8.1535730e-07, 7.9717535e-07, 7.7967236e-07, 7.6180219e-07, 7.4443066e-07,
                                7.2856830e-07, 7.1450586e-07, 7.0088660e-07, 6.8765540e-07, 6.7538202e-07,
                                6.6267737e-07, 6.4999603e-07, 6.3933038e-07, 6.3036133e-07, 6.2214221e-07,
                                6.1341302e-07, 6.0403436e-07, 5.9468842e-07, 5.8671277e-07, 5.8059766e-07,
                                5.7498517e-07, 5.6939032e-07, 5.6374298e-07, 5.5805457e-07, 5.5301721e-07,
                                5.4850867e-07, 5.4482281e-07, 5.4162775e-07, 5.3824603e-07, 5.3478845e-07,
                                5.3157739e-07, 5.2859882e-07, 5.2583746e-07, 5.2328076e-07, 5.2091199e-07,
                                5.1872162e-07, 5.1669647e-07, 5.1482220e-07, 5.1308667e-07, 5.1148004e-07,
                                5.0999289e-07, 5.0861325e-07, 5.0732758e-07, 5.0612430e-07, 5.0499158e-07,
                                5.0391702e-07, 5.0289008e-07, 5.0189755e-07, 5.0092734e-07, 4.9996619e-07,
                                4.9899921e-07, 4.9801270e-07, 4.9699310e-07, 4.9592587e-07, 4.9479718e-07,
                                4.9358936e-07, 4.9228970e-07, 4.9088162e-07, 4.8934726e-07, 4.8767184e-07,
                                4.8583951e-07, 4.8383594e-07, 4.8164798e-07, 4.7925629e-07, 4.7664539e-07,
                                4.7380594e-07, 4.7072073e-07, 4.6737854e-07, 4.6376920e-07, 4.5988043e-07,
                                4.5571075e-07, 4.5124490e-07, 4.4647473e-07, 4.4141516e-07, 4.3604837e-07,
                                4.3037637e-07, 4.2441125e-07, 4.1814981e-07, 4.1160321e-07, 4.0478369e-07,
                                3.9768237e-07, 3.9036606e-07, 3.8280203e-07, 3.7501981e-07, 3.6706396e-07,
                                3.5892419e-07, 3.5064951e-07, 3.4224255e-07, 3.3375659e-07, 3.2519550e-07,
                                3.1659717e-07, 3.0798233e-07, 2.9939157e-07, 2.9082971e-07, 2.8234537e-07,
                                2.7393796e-07, 2.6566003e-07, 2.5750650e-07, 2.4951070e-07, 2.4169688e-07,
                                2.3406468e-07, 2.2663484e-07, 2.1941837e-07, 2.1242567e-07, 2.0566843e-07,
                                1.9914946e-07, 1.9287065e-07, 1.8683585e-07, 1.8104300e-07, 1.7549232e-07,
                                1.7018111e-07, 1.6510556e-07, 1.6025978e-07, 1.5564037e-07, 1.5123787e-07,
                                1.4704872e-07, 1.4306297e-07, 1.3927217e-07, 1.3566867e-07, 1.3218730e-07,
                                1.2883455e-07, 1.2570744e-07, 1.2280119e-07, 1.2002447e-07, 1.1738745e-07,
                                1.1488692e-07, 1.1243835e-07, 1.1007292e-07, 1.0785621e-07, 1.0580288e-07,
                                1.0386935e-07, 1.0197364e-07, 1.0009019e-07, 9.8244209e-08, 9.6497612e-08,
                                9.4868713e-08, 9.3328484e-08, 9.1829971e-08, 9.0342514e-08, 8.8904350e-08,
                                8.7514183e-08, 8.6163330e-08, 8.4884987e-08, 8.3670090e-08, 8.2473732e-08,
                                8.1293228e-08, 8.0150070e-08, 7.9043312e-08, 7.7971992e-08, 7.6935318e-08,
                                7.5932571e-08, 7.4962944e-08, 7.4025543e-08, 7.3120750e-08, 7.2247086e-08,
                                7.1403999e-08, 7.0590927e-08, 6.9807411e-08, 6.9052834e-08, 6.8326630e-08,
                                6.7628235e-08, 6.6957298e-08, 6.6312515e-08, 6.5694862e-08, 6.5102898e-08,
                                6.4538475e-08, 6.3996632e-08, 6.3478455e-08, 6.2988064e-08, 6.2515633e-08,
                                6.2088760e-08, 6.1650951e-08, 6.1262135e-08, 6.0905540e-08, 6.0540550e-08,
                                6.0268284e-08, 5.9946522e-08, 5.9796078e-08, 5.9612347e-08, 5.9300888e-08,
                                5.9267666e-08, 5.9085258e-08, 5.9296494e-08, 5.8871094e-08, 5.9474415e-08,
                                6.1476555e-08, 5.8831402e-08, 5.9787106e-08, 5.9278301e-08, 5.9925106e-08,
                                5.9423576e-08, 6.0243343e-08, 6.0219692e-08, 5.9840992e-08, 5.9907806e-08,
                                5.9096317e-08, 6.1712818e-08, 6.0109982e-08, 6.0307335e-08, 5.8610394e-08,
                                5.7818413e-08, 5.7526470e-08, 1.1267761e-07, 8.2236023e-08, 6.1923225e-08,
                                6.2387665e-08, 5.9859581e-08, 6.0599319e-08, 6.0318874e-08, 6.0667576e-08,
                                5.9548794e-08, 6.1108742e-08, 6.0564842e-08, 6.0204086e-08, 6.0163651e-08,
                                6.0447464e-08, 6.0519470e-08, 5.9920025e-08, 5.9612988e-08, 5.9203617e-08,
                                5.8764439e-08, 5.6933647e-08, 5.9622971e-08, 5.5990307e-08, 5.7534927e-08,
                                5.7165520e-08, 5.5671062e-08, 5.3128845e-08, 5.5280167e-08, 6.0398746e-08,
                                5.5639328e-08, 5.1634716e-08, 5.0014988e-08, 5.2156898e-08, 5.1099960e-08,
                                4.6864136e-08, 4.3886826e-08, 5.1868553e-08, 5.6965309e-08, 5.6471226e-08,
                                5.1457512e-08, 4.2889824e-08, 4.4504360e-08, 4.5121334e-08, 3.9491467e-08,
                                3.7921131e-08, 3.9875168e-08, 5.0381966e-08, 5.0049747e-08, 5.2558193e-08,
                                4.8259502e-08, 3.5017765e-08, 3.9427307e-08, 3.5923790e-08, 3.0411037e-08,
                                3.2780293e-08, 4.3119991e-08, 4.6935379e-08, 4.7211403e-08, 4.4291142e-08,
                                4.1636143e-08, 2.8973530e-08, 3.0848419e-08, 2.5315392e-08, 2.0787739e-08,
                                2.7715296e-08, 3.7397213e-08, 4.1790646e-08, 4.2858734e-08, 3.8270470e-08,
                                3.5494709e-08, 2.2265303e-08, 2.2752110e-08, 2.1800795e-08, 1.9849861e-08,
                                3.2848110e-08, 3.9026699e-08, 4.1106171e-08, 4.0123203e-08, 3.3937340e-08,
                                3.0632933e-08, 1.8829010e-08, 1.7220194e-08, 1.5917923e-08, 1.5449844e-08,
                                2.5513193e-08, 3.1137106e-08, 3.3521545e-08, 3.3018154e-08, 2.7516844e-08,
                                2.4647093e-08, 1.5184879e-08, 1.3395007e-08, 2.2327030e-08, 2.7217796e-08,
                                2.8691757e-08, 2.8621717e-08, 2.5388609e-08, 2.1054914e-08, 1.7606556e-08,
                                1.3957446e-08, 1.0211869e-08, 8.1733809e-09, 6.7937598e-09, 8.3478527e-09,
                                1.1573672e-08, 1.6230263e-08, 2.0121946e-08, 2.1663843e-08, 1.9980810e-08,
                                1.8230742e-08, 1.1890425e-08, 9.5246973e-09, 9.2556400e-09, 1.1065035e-08,
                                1.6165781e-08, 1.7632214e-08, 1.5750751e-08, 1.1464599e-08, 8.4838238e-09,
                                6.2236500e-09, 4.8049302e-09, 7.1582775e-09, 7.7674055e-09, 9.3096342e-09,
                                1.4150698e-08, 1.7131689e-08, 1.8711870e-08, 1.9483126e-08, 1.8999777e-08,
                                1.7945910e-08, 1.4354152e-08, 9.8762531e-09, 6.2064862e-09, 5.0584679e-09,
                                9.5887098e-09, 1.3361338e-08, 1.5091534e-08, 1.3715826e-08, 1.1365108e-08,
                                9.0687866e-09, 4.8882093e-09, 5.7919140e-09, 5.1579905e-09, 4.7245641e-09,
                                9.2626247e-09, 1.1780839e-08, 1.4437984e-08, 1.2953341e-08, 1.1373133e-08,
                                7.4984097e-09, 4.2963314e-09, 5.9966116e-09, 4.4368844e-09, 3.4718609e-09,
                                5.2454882e-09, 9.5912151e-09, 9.9658785e-09, 8.6543312e-09, 7.8286433e-09,
                                4.4987411e-09, 3.3873484e-09, 4.8543220e-09, 5.2189083e-09, 4.2471762e-09,
                                5.0994453e-09, 9.9852104e-09, 1.0532121e-08, 9.2893705e-09, 7.3350539e-09,
                                3.4588881e-09, 3.8039389e-09, 6.1091685e-09, 6.3032598e-09, 5.2779427e-09,
                                3.7059147e-09, 7.4343600e-09, 9.3989058e-09, 9.1449766e-09, 5.4231677e-09,
                                3.0204649e-09, 6.0768661e-09, 6.7856798e-09, 7.9671254e-09, 7.6658678e-09,
                                6.2431135e-09, 7.7412238e-09, 1.1611691e-08, 9.4372959e-09, 3.8338332e-09,
                                6.3368778e-09, 9.3209095e-09, 1.1764165e-08, 1.0807606e-08, 1.2313779e-08,
                                9.1647396e-09, 6.4297590e-09, 9.0847874e-09, 4.8162494e-09, 5.0889626e-09,
                                1.0565254e-08, 1.4812076e-08, 1.6440260e-08, 1.4631531e-08, 1.5946937e-08,
                                1.4290399e-08, 1.2446825e-08, 9.5210819e-09, 5.9844255e-09, 1.2170580e-08,
                                2.2884439e-08, 2.6404135e-08, 2.9819027e-08, 2.1934074e-08, 1.7990387e-08,
                                1.8409866e-08, 1.1889088e-08, 6.8026099e-09, 1.5150228e-08, 2.1101385e-08,
                                1.6887077e-08, 3.4432682e-08, 1.9378185e-08, 2.2937487e-08, 2.0464197e-08,
                                1.8458294e-08, 9.4163113e-09, 2.0771553e-08, 3.1603844e-08, 2.7017204e-08,
                                1.1651676e-08, 2.0113413e-08, 3.1608503e-08, 1.3124151e-08, 2.4769722e-08,
                                1.5489309e-08, 1.3924122e-08, 1.4551901e-08, 1.2348675e-08, 7.2600050e-09,
                                2.0330894e-08, 2.2671549e-08, 9.9048252e-09, 4.9973583e-09, 1.2932522e-08,
                                1.3094554e-08, 3.2627735e-09, 3.8407443e-09, 2.1846564e-09, 3.4685094e-09,
                                4.8679838e-09, 3.8054590e-09, 2.5731137e-09, 2.4582245e-09, 1.9776840e-09,
                                2.4239511e-09, 3.1358364e-09, 2.0440836e-09, 2.5029917e-09, 2.4378867e-09,
                                2.1676559e-09, 4.3747234e-09, 3.5441055e-09, 1.3862363e-09, 4.4713306e-09,
                                3.3564324e-09, 1.9605520e-09, 3.8623242e-09, 5.6331458e-09, 4.6725211e-09,
                                3.7400744e-09, 3.5188894e-09, 6.2345238e-09, 5.1939368e-09, 9.5662713e-10,
                                5.1920180e-09, 4.4947948e-09, 1.3401276e-09, 3.6991100e-09, 6.3904181e-09,
                                1.2360828e-09, 3.9779282e-09, 6.3854074e-09, 1.5106345e-09, 3.3721461e-09,
                                6.0694051e-09, 6.9554329e-09, 5.3003449e-09, 7.4297953e-09, 1.0321697e-08,
                                1.5329431e-08, 6.8853636e-09, 8.6020756e-10, 2.6103129e-09, 1.3048942e-09,
                                6.3421232e-10, 2.3838668e-09, 1.3236219e-09, 2.7644055e-09, 4.0111141e-09,
                                1.3650000e-09, 4.8419251e-09, 1.7402623e-09, 2.3191605e-09, 5.9516773e-09,
                                1.5270556e-09, 5.0298882e-09, 2.4463601e-09, 3.6493835e-09, 5.0955243e-09,
                                1.1698582e-09, 5.0181150e-09, 1.8624843e-09, 2.6443036e-09, 2.2610385e-09,
                                2.1515768e-09, 2.1496334e-09, 1.6903979e-09, 1.6187227e-09, 9.3860918e-10,
                                1.2248980e-09, 9.2515904e-10, 1.1712694e-09, 5.5587405e-10, 9.2409402e-10,
                                8.1522131e-10, 6.5276933e-10, 1.1893343e-09, 2.4583397e-09, 1.0952785e-09,
                                2.8014214e-09, 1.2821060e-09, 4.0617671e-09, 1.7947460e-08, 2.2128742e-08,
                                9.0081511e-09, 6.7242318e-10, 3.4550025e-09])

    
    # Use a NumPy comparison for arrays
    assert np.allclose(calculation_cirsrad, expected_nemesis, rtol=5.0e-2), 'Calculated values must be close to expected values'
    assert np.allclose(calculation_cirsradg, expected_nemesis, rtol=5.0e-2), 'Calculated values must be close to expected values'
    
def test_multiple_scattering_cirs():  
    '''
    Jupiter multiple scattering test against NEMESIS
    '''
    test_dir = os.path.join(ans.archnemesis_path(), 'tests/files/Jupiter_CIRS_angled_thermal_emission_scattering/')
    os.chdir(test_dir) #Changing directory to read files
    runname = 'cirstest'
    
    #Reading the input files
    Atmosphere,Measurement,Spectroscopy,Scatter,Stellar,Surface,CIA,Layer,Variables,Retrieval = ans.Files.read_input_files(runname)
    
    #Calculating forward model with CIRSrad
    ForwardModel = ans.ForwardModel_0(runname=runname, Atmosphere=Atmosphere,Surface=Surface,Measurement=Measurement,Spectroscopy=Spectroscopy,Stellar=Stellar,Scatter=Scatter,CIA=CIA,Layer=Layer,Variables=Variables)
    SPECONV_cirsrad = ForwardModel.nemesisfm()
    calculation_cirsrad = SPECONV_cirsrad[:,0]
    os.chdir(curr)
    
    
    expected_nemesis = np.array([9.46826995e-07, 9.82491478e-07, 9.94409090e-07, 1.00018504e-06,
                           1.00031026e-06, 9.99915391e-07, 9.63123101e-07, 8.59530715e-07,
                           8.50492239e-07, 9.12812735e-07, 9.96718788e-07, 1.00614741e-06,
                           1.00713942e-06, 1.00577972e-06, 1.00137916e-06, 9.94834097e-07,
                           9.15653271e-07, 8.56024647e-07, 8.72411872e-07, 9.42074371e-07,
                           9.76645814e-07, 9.72774320e-07, 9.66802929e-07, 9.59937417e-07,
                           9.52255490e-07, 9.31282242e-07, 8.97399530e-07, 8.62770573e-07,
                           8.66857211e-07, 8.94753761e-07, 9.03220794e-07, 8.93883206e-07,
                           8.84168516e-07, 8.74107072e-07, 8.62651168e-07, 8.48678601e-07,
                           8.35116083e-07, 8.19949374e-07, 8.13655982e-07, 8.09485814e-07,
                           7.99236417e-07, 7.88064618e-07, 7.76756860e-07, 7.65318599e-07,
                           7.53750399e-07, 7.42175351e-07, 7.30366407e-07, 7.18830647e-07,
                           7.08093760e-07, 6.97228934e-07, 6.86124619e-07, 6.75120194e-07,
                           6.64249417e-07, 6.53532844e-07, 6.42981258e-07, 6.32610126e-07,
                           6.22440899e-07, 6.12467889e-07, 6.02723215e-07, 5.93209426e-07,
                           5.83903074e-07, 5.74829417e-07, 5.65987646e-07, 5.57380115e-07,
                           5.49005373e-07, 5.40609493e-07, 5.32395319e-07, 5.24603714e-07,
                           5.17292695e-07, 5.10134439e-07, 5.03113629e-07, 4.96357612e-07,
                           4.89548782e-07, 4.82792171e-07, 4.76523127e-07, 4.70657655e-07,
                           4.64982245e-07, 4.59226244e-07, 4.53365464e-07, 4.47546349e-07,
                           4.42039936e-07, 4.36933762e-07, 4.31949155e-07, 4.26985443e-07,
                           4.22031316e-07, 4.17090049e-07, 4.12294188e-07, 4.07617552e-07,
                           4.03111142e-07, 3.98714194e-07, 3.94298632e-07, 3.89886707e-07,
                           3.85537600e-07, 3.81248420e-07, 3.77016242e-07, 3.72838619e-07,
                           3.68712517e-07, 3.64636155e-07, 3.60607235e-07, 3.56623324e-07,
                           3.52682346e-07, 3.48782705e-07, 3.44922868e-07, 3.41100939e-07,
                           3.37314811e-07, 3.33562754e-07, 3.29842942e-07, 3.26153660e-07,
                           3.22493537e-07, 3.18860436e-07, 3.15252854e-07, 3.11669036e-07,
                           3.08107011e-07, 3.04565192e-07, 3.01041510e-07, 2.97534386e-07,
                           2.94042183e-07, 2.90560302e-07, 2.87092281e-07, 2.83633772e-07,
                           2.80182728e-07, 2.76737617e-07, 2.73296838e-07, 2.69859068e-07,
                           2.66423055e-07, 2.62997421e-07, 2.59559895e-07, 2.56120294e-07,
                           2.52677267e-07, 2.49230218e-07, 2.45778628e-07, 2.42321876e-07,
                           2.38860662e-07, 2.35394094e-07, 2.31922222e-07, 2.28447746e-07,
                           2.24969675e-07, 2.21489389e-07, 2.18009266e-07, 2.14530173e-07,
                           2.11054474e-07, 2.07584632e-07, 2.04120777e-07, 2.00671520e-07,
                           1.97234155e-07, 1.93812825e-07, 1.90413554e-07, 1.87035894e-07,
                           1.83685970e-07, 1.80366214e-07, 1.77079731e-07, 1.73828722e-07,
                           1.70617885e-07, 1.67449403e-07, 1.64327761e-07, 1.61253348e-07,
                           1.58231323e-07, 1.55261285e-07, 1.52348559e-07, 1.49492462e-07,
                           1.46696137e-07, 1.43961676e-07, 1.41288927e-07, 1.38679626e-07,
                           1.36135130e-07, 1.33655023e-07, 1.31240417e-07, 1.28891306e-07,
                           1.26607285e-07, 1.24387826e-07, 1.22232780e-07, 1.20139775e-07,
                           1.18108452e-07, 1.16136908e-07, 1.14222924e-07, 1.12364953e-07,
                           1.10560209e-07, 1.08806335e-07, 1.07100445e-07, 1.05439627e-07,
                           1.03820934e-07, 1.02247375e-07, 1.00716968e-07, 9.92142368e-08,
                           9.77314469e-08, 9.62767051e-08, 9.48441421e-08, 9.34292219e-08,
                           9.20490573e-08, 9.06952390e-08, 8.93427935e-08, 8.79783826e-08,
                           8.66108661e-08, 8.52657270e-08, 8.39531078e-08, 8.26636771e-08,
                           8.13682769e-08, 8.00517831e-08, 7.87235903e-08, 7.74062033e-08,
                           7.61142879e-08, 7.48285548e-08, 7.35491284e-08, 7.22797488e-08,
                           7.10047254e-08, 6.97295465e-08, 6.84753734e-08, 6.72428677e-08,
                           6.60228274e-08, 6.48164393e-08, 6.36238393e-08, 6.24462962e-08,
                           6.12840611e-08, 6.01378911e-08, 5.90083165e-08, 5.78958272e-08,
                           5.68008033e-08, 5.57233683e-08, 5.46638387e-08, 5.36224032e-08,
                           5.25991930e-08, 5.15942227e-08, 5.06075223e-08, 4.96392805e-08,
                           4.86890704e-08, 4.77573181e-08, 4.68430215e-08, 4.59495114e-08,
                           4.50713109e-08, 4.42099811e-08, 4.33700678e-08, 4.25415106e-08,
                           4.17533212e-08, 4.09467935e-08, 4.01853238e-08, 3.94515559e-08,
                           3.86992382e-08, 3.80426876e-08, 3.73229403e-08, 3.67897864e-08,
                           3.61972650e-08, 3.54722281e-08, 3.50660893e-08, 3.44440080e-08,
                           3.43353845e-08, 3.34320833e-08, 3.38119388e-08, 3.55300110e-08,
                           3.21578075e-08, 3.30012972e-08, 3.18359044e-08, 3.24870843e-08,
                           3.12087898e-08, 3.21761319e-08, 3.17134551e-08, 3.04272069e-08,
                           3.06606783e-08, 2.87309220e-08, 3.15509430e-08, 2.87445345e-08,
                           2.90067035e-08, 2.68002894e-08, 2.45609690e-08, 2.36956534e-08,
                           9.19098039e-08, 5.26404790e-08, 2.82412448e-08, 2.86743228e-08,
                           2.45819201e-08, 2.57447816e-08, 2.39355786e-08, 2.51517683e-08,
                           2.31215033e-08, 2.43221393e-08, 2.38262338e-08, 2.17178306e-08,
                           2.24709567e-08, 2.05020855e-08, 2.10107237e-08, 1.91667095e-08,
                           1.96937755e-08, 1.89962886e-08, 1.77019556e-08, 1.78877031e-08,
                           1.70103071e-08, 1.69938601e-08, 1.63101464e-08, 1.64606071e-08,
                           1.61853624e-08, 1.59312480e-08, 1.60817890e-08, 1.62259553e-08,
                           1.60974189e-08, 1.62159160e-08, 1.59366281e-08, 1.65119062e-08,
                           1.63230766e-08, 1.64536391e-08, 1.61133659e-08, 1.71513777e-08,
                           1.69573753e-08, 1.77354798e-08, 1.68387877e-08, 1.79359672e-08,
                           1.70604003e-08, 1.83220508e-08, 1.65659388e-08, 1.85662390e-08,
                           1.70378885e-08, 1.81462414e-08, 1.22229340e-08, 1.85378776e-08,
                           1.73044563e-08, 1.67079749e-08, 1.49412495e-08, 1.67662931e-08,
                           1.48017035e-08, 1.46494214e-08, 1.27313631e-08, 1.43764705e-08,
                           1.29018491e-08, 1.25517895e-08, 1.14501444e-08, 1.13088350e-08,
                           1.07921294e-08, 9.97831886e-09, 9.27257583e-09, 9.23604570e-09,
                           8.71736603e-09, 8.57296505e-09, 8.17129604e-09, 7.65732256e-09,
                           7.30164949e-09, 6.60609543e-09, 6.28614830e-09, 5.99006189e-09,
                           5.73503410e-09, 5.86359818e-09, 5.76779348e-09, 5.60832036e-09,
                           5.44866792e-09, 5.21634575e-09, 5.07254707e-09, 4.64492529e-09,
                           4.49881127e-09, 4.34577506e-09, 4.23655280e-09, 4.46373886e-09,
                           4.43486797e-09, 4.36459826e-09, 4.26867044e-09, 4.12186041e-09,
                           4.02529732e-09, 3.68260377e-09, 3.54960642e-09, 3.75838582e-09,
                           3.73809802e-09, 3.67459229e-09, 3.60028483e-09, 3.50484379e-09,
                           3.37547762e-09, 3.24117225e-09, 3.07362439e-09, 2.86503997e-09,
                           2.76062482e-09, 2.69877510e-09, 2.65214189e-09, 2.70480516e-09,
                           2.81441595e-09, 2.81985643e-09, 2.77448304e-09, 2.69561938e-09,
                           2.62457745e-09, 2.42703270e-09, 2.30817422e-09, 2.25538360e-09,
                           2.26814925e-09, 2.34941963e-09, 2.32486807e-09, 2.26061492e-09,
                           2.11859704e-09, 1.96446741e-09, 1.87772871e-09, 1.82999942e-09,
                           1.82371377e-09, 1.80707145e-09, 1.82707514e-09, 1.90024744e-09,
                           1.89040810e-09, 1.85978056e-09, 1.82495537e-09, 1.78238835e-09,
                           1.74128415e-09, 1.67721543e-09, 1.58111497e-09, 1.45173340e-09,
                           1.39276247e-09, 1.48396473e-09, 1.51352865e-09, 1.49369527e-09,
                           1.44668977e-09, 1.39838022e-09, 1.33532558e-09, 1.20074706e-09,
                           1.19503125e-09, 1.15537339e-09, 1.12492288e-09, 1.21163322e-09,
                           1.21097473e-09, 1.20809257e-09, 1.17110971e-09, 1.13992575e-09,
                           1.06348221e-09, 9.65749930e-10, 9.92139252e-10, 9.31858263e-10,
                           8.92760775e-10, 9.20558667e-10, 9.77196694e-10, 9.52911059e-10,
                           9.21539605e-10, 9.02261605e-10, 8.13915597e-10, 7.73241260e-10,
                           7.91340388e-10, 7.87818227e-10, 7.48209946e-10, 7.45320155e-10,
                           7.93781304e-10, 7.75430395e-10, 7.55306696e-10, 7.28259167e-10,
                           6.48637532e-10, 6.41068711e-10, 6.68734534e-10, 6.63019359e-10,
                           6.38971898e-10, 5.93909787e-10, 6.21582074e-10, 6.26894631e-10,
                           6.13018791e-10, 5.74037369e-10, 5.28204395e-10, 5.60752911e-10,
                           5.71000171e-10, 5.60412623e-10, 5.45977896e-10, 5.22521477e-10,
                           5.25015799e-10, 5.39147535e-10, 5.08532238e-10, 4.75992132e-10,
                           5.18410840e-10, 5.03513214e-10, 5.00699596e-10, 5.14384175e-10,
                           5.12270932e-10, 5.08924348e-10, 4.41250051e-10, 4.96510067e-10,
                           4.49065345e-10, 4.79008310e-10, 4.09329369e-10, 5.65322244e-10,
                           4.85552878e-10, 5.47498451e-10, 4.62445218e-10, 5.42840450e-10,
                           5.26396267e-10, 4.53811219e-10, 3.51111274e-10, 4.62925467e-10,
                           5.65433958e-10, 5.79740733e-10, 5.74559631e-10, 5.71520718e-10,
                           5.72408458e-10, 7.80174368e-10, 6.42313751e-10, 4.61092576e-10,
                           4.69650384e-10, 5.26802322e-10, 5.97670827e-10, 5.52535945e-10,
                           7.37275158e-10, 5.94283966e-10, 5.41403742e-10, 3.73445538e-10,
                           6.28850373e-10, 6.34850571e-10, 5.28799319e-10, 4.08274249e-10,
                           8.93283596e-10, 5.34197274e-10, 4.97238246e-10, 9.13012340e-10,
                           4.74464412e-10, 3.63905353e-10, 5.13655813e-10, 5.35037687e-10,
                           9.09207851e-10, 1.01985391e-09, 4.00798872e-10, 3.55500361e-10,
                           7.96538405e-10, 1.33224464e-09, 6.86771667e-10, 8.75283520e-10,
                           1.41762455e-09, 9.53381399e-10, 1.27612235e-09, 1.38624864e-09,
                           8.22795609e-10, 5.35604934e-10, 2.33348746e-09, 1.51381184e-09,
                           1.18008977e-09, 1.37353197e-09, 3.06460230e-09, 1.91742214e-09,
                           2.43267628e-09, 2.36965886e-09, 2.10119143e-09, 4.34216261e-09,
                           3.50886695e-09, 1.33005095e-09, 4.43569567e-09, 3.33211289e-09,
                           1.94222936e-09, 3.82686365e-09, 5.58271209e-09, 4.63493665e-09,
                           3.71176632e-09, 3.48856572e-09, 6.17266982e-09, 5.13781471e-09,
                           9.54699226e-10, 5.13975178e-09, 4.44550699e-09, 1.33586551e-09,
                           3.66224066e-09, 6.30967789e-09, 1.23154044e-09, 3.93733138e-09,
                           6.31141253e-09, 1.50627576e-09, 3.35111859e-09, 6.00927666e-09,
                           6.89734646e-09, 5.25514476e-09, 7.35017261e-09, 1.02049487e-08,
                           1.51920424e-08, 6.83565412e-09, 8.56281996e-10, 2.57855460e-09,
                           1.29932971e-09, 6.32014504e-10, 2.35545930e-09, 1.31293358e-09,
                           2.73789186e-09, 3.96838761e-09, 1.35404436e-09, 4.78630590e-09,
                           1.72559817e-09, 2.29418639e-09, 5.88737190e-09, 1.51875383e-09,
                           4.97542423e-09, 2.42729608e-09, 3.61600319e-09, 5.04658201e-09,
                           1.16665788e-09, 4.96889231e-09, 1.84815487e-09, 2.62524497e-09,
                           2.24607689e-09, 2.13591790e-09, 2.13287859e-09, 1.67513514e-09,
                           1.60239782e-09, 9.17084695e-10, 1.20101576e-09, 8.71000284e-10,
                           1.11809349e-09, 3.00177389e-10, 6.58973661e-10, 3.03426942e-10,
                           4.80410576e-10, 3.91136682e-10, 1.94781929e-10, 3.15028059e-10,
                           1.13109403e-10, 2.85760887e-10, 1.57417775e-10, 9.16895863e-11,
                           9.61232342e-11, 1.80943924e-10, 2.78555559e-10, 1.36275909e-10])
    
    assert np.allclose(calculation_cirsrad, expected_nemesis, rtol=5.0e-2), "Calculated values must be close to expected values"

def test_solar_occultation_mars():  
    '''
    Mars solar occultation test
    '''
    test_dir = os.path.join(ans.archnemesis_path(), 'tests/files/Mars_solar_occultation/')
    os.chdir(test_dir) #Changing directory to read files
    runname = 'mars_solocc'
    
    #Reading the input files
    Atmosphere,Measurement,Spectroscopy,Scatter,Stellar,Surface,CIA,Layer,Variables,Retrieval,Telluric = ans.Files.read_input_files_hdf5(runname)
    
    #Calculating forward model with CIRSrad
    ForwardModel = ans.ForwardModel_0(runname=runname, Atmosphere=Atmosphere,Surface=Surface,Measurement=Measurement,Spectroscopy=Spectroscopy,Stellar=Stellar,Scatter=Scatter,CIA=CIA,Layer=Layer,Variables=Variables)
    SPECONV = ForwardModel.nemesisSOfm()
    SPECONVg,dSPECONV = ForwardModel.nemesisSOfmg()
    
    #Reading the reference results
    expected_speconv = np.load('reference_result.npy')
    np.testing.assert_allclose(SPECONV, expected_speconv, rtol=1e-5, atol=1e-8)
    np.testing.assert_allclose(SPECONVg, expected_speconv, rtol=1e-5, atol=1e-8)
    
def test_titan_avefov():  
    '''
    Titan test where several geometry across the planet are averaged
    '''
    test_dir = os.path.join(ans.archnemesis_path(), 'tests/files/Titan_aveFOV/')
    os.chdir(test_dir) #Changing directory to read files
    runname = 'ch3cn'
    
    #Reading the input files
    Atmosphere,Measurement,Spectroscopy,Scatter,Stellar,Surface,CIA,Layer,Variables,Retrieval = ans.Files.read_input_files(runname)
    
    #Calculating forward model with CIRSrad
    ForwardModel = ans.ForwardModel_0(runname=runname, Atmosphere=Atmosphere,Surface=Surface,Measurement=Measurement,Spectroscopy=Spectroscopy,Stellar=Stellar,Scatter=Scatter,CIA=CIA,Layer=Layer,Variables=Variables)
    SPECONV = ForwardModel.nemesisfm()
    SPECONVg,dSPECONV = ForwardModel.nemesisfmg()
    
    #Reading the file from NEMESIS
    lat,lon,ngeom,ny,wave1,expected_speconv,specmeas1,specerrmeas,nx,Var,aprprof,aprerr,retprof,reterr = ans.read_mre(runname)
    expected_speconv *= 1.0e-9
    
    #Comparing the forward models
    np.testing.assert_allclose(SPECONV, expected_speconv, rtol=1e-5, atol=1e-8)
    np.testing.assert_allclose(SPECONVg, expected_speconv, rtol=1e-5, atol=1e-8)
    