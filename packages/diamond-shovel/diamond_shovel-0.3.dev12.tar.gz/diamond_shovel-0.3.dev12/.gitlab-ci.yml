stages:
  - build
  - build-docker
  - branch
  - release
  - trigger

build:
  stage: build
  image: gitlab.cyberspike.top:5050/docker/python:3.13.3
  script:
    - sed -i 's|http://deb.debian.org/debian|http://mirrors.huaweicloud.com/debian|g; s|http://deb.debian.org/debian-security|http://mirrors.huaweicloud.com/debian-security|g' /etc/apt/sources.list.d/debian.sources && apt-get update && apt-get install -y patchelf
    - pip config set global.index-url https://mirrors.huaweicloud.com/repository/pypi/simple
    - pip install build
    - python -m build --wheel
  tags:
    - docker
  artifacts:
    paths:
      - dist/

build-docker:
  stage: build-docker
  image: gitlab.cyberspike.top:5050/docker/docker:dind
  services:
    - name: gitlab.cyberspike.top:5050/docker/docker:dind
      alias: docker
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login $CI_REGISTRY -u $CI_REGISTRY_USER --password-stdin
  tags:
    - docker
  script:
    - docker build -t gitlab.cyberspike.top:5050/aszl/diamond-shovel/diamond-shovel:$(echo -n "$CI_COMMIT_REF_NAME" |  sed 's/[^a-zA-Z0-9._-]/_/g') .
    - docker push gitlab.cyberspike.top:5050/aszl/diamond-shovel/diamond-shovel:$(echo -n "$CI_COMMIT_REF_NAME" |  sed 's/[^a-zA-Z0-9._-]/_/g')
branch:
  stage: branch
  image: gitlab.cyberspike.top:5050/docker/alpine/curl:8.9.1
  script:  |
    curl -X POST -H "Content-Type: application/json" -d '{"project_name": "diamond-shovel", "branch_name": "'$(echo -n "$CI_COMMIT_REF_NAME" |  sed 's/[^a-zA-Z0-9._-]/_/g')'"}' http://workbench.dev.cyberspike.top:2333/update_branch
  tags:
    - docker

release-to-pypi:
  stage: release
  image: gitlab.cyberspike.top:5050/docker/python:3.13.3
  script:
    - export PIP_INDEX_URL=https://mirrors.aliyun.com/pypi/simple/
    - pip install --upgrade 'setuptools-scm[toml]' setuptools build twine -i https://mirrors.aliyun.com/pypi/simple/
    - rm -rf build/ dist/ *.egg-info/
    - python -m build --sdist --wheel .
    - twine upload
      --username __token__
      --password "$PYPI_API_TOKEN"
      --repository-url https://upload.pypi.org/legacy/
      --verbose
      dist/*

  tags:
    - docker

trigger:
  stage: trigger
  trigger:
    project: aszl/diamond-shovel/shovel-workbench
    branch: dev
