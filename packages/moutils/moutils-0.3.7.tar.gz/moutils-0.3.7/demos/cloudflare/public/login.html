<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>OAuth Callback Handler</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
        padding: 50px;
        background-color: #f5f5f5;
      }
      .message {
        color: #333;
        font-size: 18px;
        margin: 20px 0;
      }
      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #f38020;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 2s linear infinite;
        margin: 20px auto;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body>
    <div id="content">
      <div class="spinner"></div>
      <div class="message">Processing OAuth callback...</div>
    </div>

    <script>
      // Handle OAuth callback - check for callback parameters on page load
      if (window.location.search.indexOf("code") !== -1) {
        var params = new URLSearchParams(window.location.search);
        var code = params.get("code");
        var state = params.get("state");
        
        if (code && state) {
          try {
            // Decode the state parameter (base64url encoded)
            var decodedState = atob(state.replace(/-/g, '+').replace(/_/g, '/'));
            var stateData = JSON.parse(decodedState);

            // Extract the href from the state
            var redirectUrl = new URL(stateData.href);
            
            // Add all current query parameters to the redirect URL
            for (var [key, value] of params.entries()) {
              redirectUrl.searchParams.set(key, value);
            }
            
            // if opened in a new tab (popup), notify parent and close using localStorage
            window.DEBUG_OAUTH_PAUSE=true;
            var debugPause = window.DEBUG_OAUTH_PAUSE === true;
            if (window.opener && window.opener !== window) {
              try {
                // Store the OAuth data in the format that PKCEFlow expects
                localStorage.setItem('__pkce_auth_code', code);
                localStorage.setItem('__pkce_state', state);
                
                // Also store all params for completeness
                for (var [key, value] of params.entries()) {
                  localStorage.setItem('__pkce_' + key, value);
                }
                
                if (debugPause) {
                  document.getElementById("content").innerHTML =
                    "<div class='spinner'></div><div class='message'>Login successful! This tab will close in 3 seconds...</div>";
                  setTimeout(function() {
                    window.close();
                  }, 3000);
                } else {
                  window.close();
                }
              } catch (e) {
                // Fallback to redirect if localStorage or close fails
                if (debugPause) {
                  document.getElementById("content").innerHTML =
                    "<div class='spinner'></div><div class='message'>Login successful! Redirecting in 3 seconds...</div>";
                  setTimeout(function() {
                    window.location.href = redirectUrl.toString();
                  }, 3000);
                } else {
                  window.location.href = redirectUrl.toString();
                }
              }
            } else {
              // Not a popup/new tab, do the redirect as before
              if (debugPause) {
                document.getElementById("content").innerHTML =
                  "<div class='spinner'></div><div class='message'>Login successful! Redirecting in 3 seconds...</div>";
                setTimeout(function() {
                  window.location.href = redirectUrl.toString();
                }, 3000);
              } else {
                window.location.href = redirectUrl.toString();
              }
            }
            
          } catch (error) {
            console.error("Error processing state parameter:", error);
            document.getElementById("content").innerHTML = 
              "<div class='message'>Error processing callback: " + error.message + "</div>";
          }
        } else {
          document.getElementById("content").innerHTML = 
            "<div class='message'>Invalid callback parameters</div>";
        }
      } else {
        // No callback parameters, redirect to original URL
        var originalUrl = localStorage.getItem("original_url");
        if (originalUrl) {
          window.location.href = originalUrl;
        } else {
          window.location.href = window.top.location.origin;
        }
      }

      // Handle storage events for popup-based login
      window.addEventListener("storage", function (e) {
        // Check if PKCEFlow auth code was stored (indicating OAuth callback completed)
        if (e.key === '__pkce_auth_code' && e.newValue) {
          console.log("OAuth callback completed, auth code stored:", e.newValue.substring(0, 20) + '...');
          // Get code and state from localStorage
          var code = localStorage.getItem('__pkce_auth_code');
          var state = localStorage.getItem('__pkce_state');
          if (code && state) {
            window.history.pushState({}, '', window.location.pathname + '?code=' + encodeURIComponent(code) + '&state=' + encodeURIComponent(state));
            window.dispatchEvent(new PopStateEvent('popstate'));
          }
        }
      });
    </script>
  </body>
</html>
