"use strict";(self.webpackChunkhome_assistant_frontend=self.webpackChunkhome_assistant_frontend||[]).push([["4691"],{27127:function(e,n,t){t.r(n),t.d(n,{ExternalAuth:function(){return w},createExternalAuth:function(){return u}});t(40777),t(21700),t(1455);var s=t(79834),a=t(29694),r=t(75778),i=t(54521),o=t(4490),c=(t(54480),function(){return(0,o.Z)(function e(){(0,i.Z)(this,e),this.commands={},this.msgId=0},[{key:"attach",value:(e=(0,r.Z)((0,a.Z)().m(function e(){var n=this;return(0,a.Z)().w(function(e){for(;;)switch(e.n){case 0:return window.externalBus=function(e){return n.receiveMessage(e)},window.addEventListener("connection-status",function(e){return n.fireMessage({type:"connection-status",payload:{event:e.detail}})}),e.n=1,this.sendMessage({type:"config/get"});case 1:this.config=e.v;case 2:return e.a(2)}},e,this)})),function(){return e.apply(this,arguments)})},{key:"addCommandHandler",value:function(e){this._commandHandler=e}},{key:"sendMessage",value:function(e){var n=this,t=++this.msgId;return e.id=t,this._sendExternal(e),new Promise(function(e,s){n.commands[t]={resolve:e,reject:s}})}},{key:"fireMessage",value:function(e){e.id||(e.id=++this.msgId),this._sendExternal(e)}},{key:"receiveMessage",value:function(e){if("command"!==e.type){var n=this.commands[e.id];n?"result"===e.type&&(e.success?n.resolve(e.result):n.reject(e.error)):console.warn("Received unknown msg ID",e.id)}else{var t,s;this._commandHandler&&this._commandHandler(e)||(this._commandHandler?(t="not_ready",s="Command handler not ready"):(t="unknown_command",s="Unknown command ".concat(e.command)),console.warn(s,e),this.fireMessage({id:e.id,type:"result",success:!1,error:{code:t,message:s}}))}}},{key:"_sendExternal",value:function(e){window.externalApp?window.externalApp.externalBus(JSON.stringify(e)):window.webkit.messageHandlers.externalBus.postMessage(e)}}]);var e}());const d="externalAuthSetToken",l="externalAuthRevokeToken";if(!window.externalApp&&!window.webkit)throw new Error("External auth requires either externalApp or webkit defined on Window object.");class w extends s.gx{async refreshAccessToken(e){if(this._tokenCallbackPromise&&!e)try{return void(await this._tokenCallbackPromise)}catch(s){this._tokenCallbackPromise=void 0}const n={callback:d};e&&(n.force=!0),this._tokenCallbackPromise=new Promise((e,n)=>{window[d]=(t,s)=>t?e(s):n(s)}),await Promise.resolve(),window.externalApp?window.externalApp.getExternalAuth(JSON.stringify(n)):window.webkit.messageHandlers.getExternalAuth.postMessage(n);const t=await this._tokenCallbackPromise;this.data.access_token=t.access_token,this.data.expires=1e3*t.expires_in+Date.now(),this._tokenCallbackPromise=void 0}async revoke(){const e={callback:l},n=new Promise((e,n)=>{window[l]=(t,s)=>t?e(s):n(s)});await Promise.resolve(),window.externalApp?window.externalApp.revokeExternalAuth(JSON.stringify(e)):window.webkit.messageHandlers.revokeExternalAuth.postMessage(e),await n}constructor(e){super({hassUrl:e,clientId:"",refresh_token:"",access_token:"",expires_in:0,expires:0})}}const u=async e=>{var n;const t=new w(e);return(null!==(n=window.externalApp)&&void 0!==n&&n.externalBus||window.webkit&&window.webkit.messageHandlers.externalBus)&&(t.external=new c,await t.external.attach()),t}}}]);
//# sourceMappingURL=4691.eaf1c4c815d1c2b1.js.map