"use strict";(self.webpackChunk_fails_components_jupyter_interceptor=self.webpackChunk_fails_components_jupyter_interceptor||[]).push([[961],{961:(e,t,o)=>{o.r(t),o.d(t,{AppletWidgetRegistry:()=>c,IFailsInterceptor:()=>d,default:()=>p});var s=o(341),n=o(974),i=o(606),a=o(602);const d=new(o(262).Token)("@fails-components/jupyter-fails:IFailsInterceptor","A service to talk with FAILS interceptor."),r=new Set(["text/html","text/plain","image/bmp","image/png","image/jpeg","image/gif","image/webp","text/latex","text/markdown","image/svg+xml","application/vnd.jupyter.stderr","application/vnd.jupyter.stdout"]),l=new Set(["application/vnd.jupyter.widget-view+json"]);class c{constructor(e){this._modelIdToPath={},this._pathToModelId={},this._pathToModel={},this._updateMessageArrived=new a.Signal(this),e.updateMessageArrived=this._updateMessageArrived}registerModel(e,t,o){this._modelIdToPath[t]=e,this._pathToModelId[e]=t,this._pathToModel[e]=o}unregisterPath(e){const t=this._pathToModelId[e];t&&delete this._modelIdToPath[t],delete this._pathToModelId[e],delete this._pathToModel[e]}unregisterModel(e){const t=this._modelIdToPath[e];delete this._modelIdToPath[e],t&&(delete this._pathToModelId[t],delete this._pathToModel[t])}getModelId(e){return this._pathToModelId[e]}getModel(e){return this._pathToModel[e]}getPath(e){return this._modelIdToPath[e]}dispatchMessage(e){this._updateMessageArrived.emit(e)}}const p=[{id:"@fails-components/jupyter-applet-widget:interceptor",description:"Tracks and intercepts widget communication",autoStart:!0,activate:function(e,t,o,s){const n=new c(s);if("JupyterLite Server"===e.namespace)return{isMimeTypeSupported:e=>!1};const i=e=>{e.anyMessage.connect(((e,t)=>{const{direction:o,msg:s}=t;if("send"===o){const{content:e,channel:t}=s;if("shell"===t){const{data:t,comm_id:o}=e;if("update"===(null==t?void 0:t.method)){const e=n.getPath(o);if(e&&"object"==typeof t.state){const o={...t.state};o.outputs&&delete o.outputs,0!==Object.keys(o).length&&n.dispatchMessage({path:e,mime:a,state:o})}}}}})),s.remoteUpdateMessageArrived.connect((async(e,t)=>{const o=n.getModel(t.path);if(!o)return;const s=await o.constructor._deserialize_state(t.state,o.widget_manager);for(const[e,t]of Object.entries(s))o.set(e,t);o.sync("patch",o,{attrs:s})}))},a="application/vnd.jupyter.widget-view+json";return t.widgetAdded.connect(((e,t)=>{var o;(null===(o=t.sessionContext.session)||void 0===o?void 0:o.kernel)&&i(t.sessionContext.session.kernel),t.sessionContext.kernelChanged.connect(((e,t)=>{t.newValue&&i(t.newValue)}));const s=t.context.sessionContext.ready.then((()=>new Promise(((e,o)=>{requestAnimationFrame((async()=>{const s=t.content.rendermime.getFactory(a);if(s){const t=s.createRenderer({mimeType:a,sanitizer:{sanitize:(e,t)=>""},resolver:{getDownloadUrl:e=>Promise.resolve(""),resolveUrl:e=>Promise.resolve("")},latexTypesetter:null,linkHandler:null});e(await t._manager.promise),t.dispose()}else o(new Error("No widgetFactory found for widget view"))}))}))));null==s||s.then((e=>{const o=t.model;if(o){const t=new WeakSet,s=[],i=async(t,o)=>{if(null==e?void 0:e.has_model(o)){const s=await(null==e?void 0:e.get_model(o)),a=t+(s.name?"/"+s.name:""),d=s.get_state().children;d&&d.forEach(((e,t)=>{i(a+"/"+t,e.model_id)})),n.registerModel(a,s.model_id,s)}else s.push({path:t,widget_model_id:o})},d=e=>{if(!t.has(e)){t.add(e);const o=()=>{if("code"===e.type){const t=e.sharedModel;let o=0;for(const s of t.outputs){const n=e.id+"/"+o;let d=!1;switch(s.output_type){case"display_data":case"update_display_data":case"execute_result":{const e=s.data;if(e[a]){const{model_id:t}=e[a];i(n,t)}e["application/vnd.plotly.v1+json"]}}d&&t.updateOutputs(o,o+1,[s]),o++}}};e.contentChanged.connect(o),o()}};for(const e of o.cells)d(e);o.cells.changed.connect(((e,t)=>{const{newValues:o}=t;o.forEach((e=>{d(e)}))}))}}))})),{isMimeTypeSupported:e=>!!r.has(e)||!!l.has(e)}},provides:d,requires:[s.INotebookTracker,n.IRenderMimeRegistry,i.IFailsLauncherInfo],optional:[]}]}}]);