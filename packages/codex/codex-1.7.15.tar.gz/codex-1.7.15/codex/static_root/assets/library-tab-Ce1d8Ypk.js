import{_ as C,B as k,D as v,C as D,q as g,v as p,a as r,w as s,m as L,Y as J,x as w,E as I,H as F,s as u,A as _,M as z,ag as Q,N as X,ao as $,a0 as B,bx as Z,by as ee,bz as te,b as o,d as oe,y as i,k as re,bA as le,F as se,z as ie}from"./main-CpP-5rLh.js";import{A as ne,R as ae,a as j,b as de,c as me}from"./relation-chips-QzwrdJWs.js";import{useAdminStore as h}from"./admin-BQ68PA7O.js";import{a as ue}from"./VDialog-tf0N3lvG.js";import{V as pe}from"./VCombobox-DKyNgHNV.js";import{V}from"./VCheckbox-DraWPvy6.js";import{c as ce,d as U}from"./VSelectionControl-DoFzRlEh.js";import{D as N}from"./datetime-column-m-oshrDM.js";import{C as he}from"./confirm-dialog-AMnfyuMm.js";import{V as O}from"./VCheckboxBtn-Bxf1MS02.js";import{V as A,a as x,b as T,c as P}from"./VExpansionPanels-BjwwzLx6.js";import{k as R}from"./forwardRefs-CGpIPavG.js";import{V as fe}from"./VTable-C-cNChDa.js";import"./VForm-Dw7aCtM5.js";import"./VSelect-Cv8OuNtL.js";import"./ssrBoot-D216TWr1.js";import"./VDivider-CTvTvFr_.js";import"./filter-BucmWboA.js";const be={name:"AdminServerFolderPicker",emits:["change","menu"],data(){return{path:"",originalPath:"",showHidden:!1,menuOpen:!1}},computed:{...v(h,{folders:e=>e.folderPicker.folders,rootFolder:e=>e.folderPicker.rootFolder}),...v(D,{formErrors:e=>e.form.errors}),appendOuterIcon(){return this.showHidden?this.mdiFolderHidden:this.mdiFolderOutline},showHiddenTooltipPrefix(){return this.showHidden?"Hide":"Show"}},watch:{menuOpen(e){e&&this.$emit("menu",e)}},created(){this.loadFolders().then(()=>(this.path=this.rootFolder,this.originalPath=this.rootFolder,!0)).catch(console.warn)},methods:{...k(h,["clearFolders","loadFolders"]),...k(D,["clearErrors"]),change(e){let t;e?t=e.startsWith("/")||e.startsWith("\\")?e:[this.rootFolder,e].join("/"):t=this.rootFolder;const m=this.menuOpen;this.clearErrors(),this.loadFolders(t,this.showHidden).then(()=>{this.menuOpen=m;let b="";return this.formErrors.length===0&&(this.path=b=this.rootFolder),this.$emit("change",b)}).catch(console.warn)},onBlur(){this.menuOpen=!1,this.change(this.path)},onClear(){this.clearFolders(this.orignalPath).then(()=>this.change(this.orginalPath)).catch(console.error)},onKeyDownEnter(){this.change(this.path)},onItemClick(e){this.change(e)}}},ye={id:"folderPicker"};function ve(e,t,m,b,l,n){return p(),g("div",ye,[r(pe,L({modelValue:l.path,"onUpdate:modelValue":t[0]||(t[0]=d=>l.path=d),menu:l.menuOpen,"onUpdate:menu":t[1]||(t[1]=d=>l.menuOpen=d)},e.$attrs,{"aria-label":"Library folder",clearable:"","error-messages":e.formErrors,"full-width":"","hide-details":"auto",items:e.folders,"menu-props":{maxHeight:"370px"},"validate-on":"blur",variant:"filled",onBlur:n.onBlur,"onClick:clear":n.onClear,onKeydown:J(n.onKeyDownEnter,["enter"])}),{item:s(({item:d,props:f})=>[r(ue,L(f,{title:d.title,value:d.value,onClick:y=>n.onItemClick(d.value)}),null,16,["title","value","onClick"])]),_:1},16,["modelValue","menu","error-messages","items","onBlur","onClick:clear","onKeydown"]),r(V,{modelValue:l.showHidden,"onUpdate:modelValue":t[2]||(t[2]=d=>l.showHidden=d),density:"compact",class:"showHidden","hide-details":"auto",label:"Show Hidden Folders"},null,8,["modelValue"])])}const ge=C(be,[["render",ve],["__scopeId","data-v-61ca3769"]]),S="DDD HH:mm:SS",we=/^(?:[0-3]?\d?\d\s)?(?:[01]?\d|2[0-3])(?::[0-5]\d){2}$/,Ce={name:"TimeTextField",data(){return{FORMAT:S,timeRules:[e=>we.test(e)||`Invalid time format ${S}`]}}};function _e(e,t,m,b,l,n){return p(),w(ce,L({ref:"timeField",density:"compact",filled:"",hint:l.FORMAT,round:"",rules:l.timeRules},e.$attrs),null,16,["hint","rules"])}const ke=C(Ce,[["render",_e]]),W=["events","poll","pollEvery","groups"];Object.freeze(W);const E={path:"",events:!0,poll:!0,pollEvery:"01:00:00",groups:[]};Object.freeze(E);const H=(e,t)=>(e=e.replaceAll("\\","/"),t=t.replaceAll("\\","/"),e.endsWith("/")||(e+="/"),t.endsWith("/")||(t+="/"),t.startsWith(e)),Fe={name:"AdminLibraryCreateUpdateInputs",components:{AdminRelationPicker:ne,AdminServerFolderPicker:ge,TimeTextField:ke},props:{oldRow:{type:[Object,Boolean],default:!1}},emits:["change"],data(){return{rules:{path:[e=>!!e||"Path is required",e=>{if(!e)return!1;for(const t of this.paths){if(H(t,e))return"Path is a child of an existing library";if(H(e,t))return"Path is a parent of an existing library"}return!0}]},row:z(this.oldRow||E)}},computed:{...I(h,["normalLibraries"]),...v(h,{groups:e=>e.groups}),paths(){return this.nameSet(this.normalLibraries,"path",this.oldRow,!1)}},watch:{row:{handler(e){this.$emit("change",e)},deep:!0},oldRow:{handler(e){this.row=z(e)},deep:!0}},methods:{...k(h,["nameSet"])},UPDATE_KEYS:W,EMPTY_ROW:E},Ae={key:1};function xe(e,t,m,b,l,n){const d=u("AdminServerFolderPicker"),f=u("TimeTextField"),y=u("AdminRelationPicker");return p(),g("section",null,[m.oldRow?(p(),g("div",Ae,_(m.oldRow.path),1)):(p(),w(d,{key:0,rules:l.rules.path,autofocus:"",label:"Library Folder",onChange:t[0]||(t[0]=c=>l.row.path=c)},null,8,["rules"])),r(V,{modelValue:l.row.events,"onUpdate:modelValue":t[1]||(t[1]=c=>l.row.events=c),"hide-details":"auto",hint:"Update Codex instantly when the filesystem changes",label:"Watch Filesystem Events","persistent-hint":!0},null,8,["modelValue"]),r(V,{modelValue:l.row.poll,"onUpdate:modelValue":t[2]||(t[2]=c=>l.row.poll=c),label:"Poll Filesystem Periodically","hide-details":"auto",hint:"Periodically poll the library for changes","persistent-hint":!0},null,8,["modelValue"]),r(f,{modelValue:l.row.pollEvery,"onUpdate:modelValue":t[3]||(t[3]=c=>l.row.pollEvery=c),label:"Poll Every",disabled:!l.row.poll},null,8,["modelValue","disabled"]),l.row.coversOnly?F("",!0):(p(),w(y,{key:2,modelValue:l.row.groups,"onUpdate:modelValue":t[4]||(t[4]=c=>l.row.groups=c),label:"Groups",objs:e.groups,"group-type":"","title-key":"name"},null,8,["modelValue","objs"]))])}const G=C(Fe,[["render",xe]]),Te={name:"AdminLibrariesTab",components:{AdminTable:me,AdminDeleteRowDialog:de,AdminCreateUpdateDialog:j,RelationChips:ae,ConfirmDialog:he,DateTimeColumn:N},props:{coversDir:{type:Boolean,default:!1}},data(){return{lastUpdate:{pk:0,field:void 0},mdiCircleOffOutline:te,mdiDatabaseClockOutline:ee,mdiDatabaseSyncOutline:Z,mdiOpenInNew:B,AdminLibraryCreateUpdateInputs:$(G)}},computed:{...I(h,["normalLibraries","customCoverLibraries"]),...v(h,{groups:e=>e.groups}),...v(D,{formErrors:e=>e.form?.errors}),...v(X,{twentyFourHourTime:e=>e.settings.twentyFourHourTime}),headers(){const e=[{title:"Path",key:"path",align:"start"},{title:"Watch File Events",key:"events"},{title:"Poll Files Periodically",key:"poll"},{title:"Poll Every",key:"pollEvery"},{title:"Last Poll",key:"lastPoll"}];return this.coversDir||e.push({title:"Groups",key:"groups"}),e.push({title:"Actions",key:"actions",sortable:!1}),e},items(){return globalThis.coversDir?this.customCoverLibraries:this.normalLibraries},updateLabel(){return this.coversDir?"Cover Dir":""},itemName(){return this.coversDir?"custom covers":"comics"},iconSize(){const e=this.$vuetify.display;return e.xlAndUp?"x-large":e.lgAndUp?"large":e.mdAndUp?"default":"small"}},mounted(){this.loadTables(["Group","Library","FailedImport"])},methods:{...k(h,["updateRow","clearErrors","librarianTask","loadTables"]),formatDateTime(e){return e?Q(e,this.twentyFourHourTime):""},changeCol(e,t,m){this.lastUpdate.pk=e,this.lastUpdate.field=t;const b={[t]:m};this.updateRow("Library",e,b)},getFormErrors(e,t){if(e===this.lastUpdate.pk&&t===this.lastUpdate.field)return this.formErrors},libraryLabel(e,t=!0){let m="";return e.coversOnly?(t&&(m+="Custom Group "),m+="Cover Dir"):m+="Library",m},poll(e){const t=this.libraryLabel(e);this.librarianTask("poll",`Poll ${t} ${e.pk}`,e.pk)},forcePoll(e){const t=this.libraryLabel(e);this.librarianTask("poll_force",`Force Poll ${t} ${e.pk}`,e.pk)},pollConfirmText(e){return`Poll ${this.libraryLabel(e,!1)}`}}},Pe={class:"actionButtonCell"};function Ie(e,t,m,b,l,n){const d=u("DateTimeColumn"),f=u("RelationChips"),y=u("ConfirmDialog"),c=u("AdminCreateUpdateDialog"),M=u("AdminDeleteRowDialog"),Y=u("AdminTable");return p(),w(Y,{headers:n.headers},{"no-data":s(()=>t[0]||(t[0]=[o("td",{class:"adminNoData",colspan:"100%"}," Add a Library to start using Codex ",-1)])),"item.events":s(({item:a})=>[r(O,{"model-value":a.events,disabled:""},null,8,["model-value"])]),"item.poll":s(({item:a})=>[r(O,{"model-value":a.poll,disabled:""},null,8,["model-value"])]),"item.pollEvery":s(({item:a})=>[o("span",{class:oe({disabled:!a.poll})},_(a.pollEvery),3)]),"item.lastPoll":s(({item:a})=>[r(d,{dttm:a.lastPoll},null,8,["dttm"])]),"item.groups":s(({item:a})=>[r(f,{pks:a.groups,objs:e.groups,"group-type":"","title-key":"name"},null,8,["pks","objs"])]),"item.actions":s(({item:a})=>[o("span",Pe,[r(y,{icon:l.mdiDatabaseClockOutline,"title-text":`Poll for updated ${n.itemName}`,text:a.path,"confirm-text":n.pollConfirmText(a),size:n.iconSize,density:"compact",onConfirm:q=>n.poll(a)},null,8,["icon","title-text","text","confirm-text","size","onConfirm"]),r(y,{icon:l.mdiDatabaseSyncOutline,"title-text":`Force update every ${n.itemName}`,text:a.path,"confirm-text":"Force Update",size:n.iconSize,density:"compact",onConfirm:q=>n.forcePoll(a)},null,8,["icon","title-text","text","size","onConfirm"]),r(c,{table:"Library","old-row":a,inputs:l.AdminLibraryCreateUpdateInputs,label:n.updateLabel,"max-width":"22em",size:n.iconSize,density:"compact"},null,8,["old-row","inputs","label","size"]),a.coversOnly?F("",!0):(p(),w(M,{key:0,table:"Library",pk:a.pk,name:a.path,size:n.iconSize,density:"compact"},null,8,["pk","name","size"]))])]),_:2},1032,["headers"])}const K=C(Te,[["render",Ie],["__scopeId","data-v-7b626283"]]),De={name:"AdminCustomCoversPanel",components:{AdminLibraryTable:K},computed:{...I(h,["customCoverLibraries"])}};function Le(e,t,m,b,l,n){const d=u("AdminLibraryTable");return p(),w(A,null,{default:s(()=>[r(x,null,{default:s(()=>[r(T,null,{default:s(()=>t[0]||(t[0]=[o("h4",{id:"coverDirHeader"},"Custom Covers",-1)])),_:1,__:[0]}),r(P,null,{default:s(()=>[r(d,{items:e.customCoverLibraries,"disable-sort":"","covers-dir":!0},null,8,["items"]),r(A,null,{default:s(()=>[r(x,{id:"customCoversHelp"},{default:s(()=>[r(T,null,{default:s(()=>t[1]||(t[1]=[o("h4",null,"Custom Covers Help",-1)])),_:1,__:[1]}),r(P,null,{default:s(()=>t[2]||(t[2]=[o("p",null,"Custom covers may be added to the browser in two locations:",-1),o("h4",null,"Folders",-1),o("p",null,[i(" A library folder with a file named "),o("code",null,".codex-cover.jpg"),i(" will show a custom cover for that folder in Folder view. The addition and removal of these covers by watching filesystem events and polling is handled by the library that folder belongs to. ")],-1),o("h4",null,"Custom Covers Dir",-1),o("p",null,[i(" The Codex config directory has a special folder named "),o("code",null,"custom-covers"),i(" under which are subdirectories for each of the browser groups that may adopt custom covers. Images in these subdirectories that match the name of the browser group will be used as custom covers. For instance: "),o("code",null,".../custom-covers/publishers/American Comics Group.webp"),i(' would be used as the cover for the publisher "American Comics Group". '),o("code",null,".../custom-covers/series/arrow.png"),i(' would be used as the cover for every series named "Arrow", for '),o("em",null,"every"),i(" publisher. Similar to a comic library, the "),o("code",null,"custom-covers"),i(" directory may be watched and polled for changes. By default it is neither watched nor polled and must be enabled by the admin. ")],-1),o("h4",null,"Image Formats & Size",-1),o("p",null,[i(" Custom covers are detected only for files with the extensions: "),o("code",null,".bmp, .gif, .jpeg, .jpg, .png, .webp"),i(". ")],-1),o("p",null," Browser covers are transformed from their sources to 165px x 254px thumbnails. Custom covers will transform most aesthetically the closer to that ratio they are. ",-1),o("h4",null,"Priority",-1),o("p",null," Custom covers supersede covers set by the user's individual browser settings. ",-1)])),_:1,__:[2]})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})}const Ve=C(De,[["render",Le],["__scopeId","data-v-09e17970"]]),Ee={name:"AdminFailedImportsPanel",components:{DateTimeColumn:N},data(){return{mdiBookAlert:le,mdiOpenInNew:B}},computed:{...v(h,{failedImports:e=>e.failedImports,showFailedImports:e=>e.failedImports&&e.failedImports.length>0}),...re(h,["unseenFailedImports"])}},ze={key:0},Ue={class:"dateCol"},Oe={href:"https://github.com/ajslater/codex/issues/",target:"_blank"};function Re(e,t,m,b,l,n){const d=u("DateTimeColumn");return e.showFailedImports?(p(),g("div",ze,[r(A,null,{default:s(()=>[r(x,{id:"failedImportsPanel",onClick:t[0]||(t[0]=f=>e.unseenFailedImports=!1)},{default:s(()=>[r(T,null,{default:s(()=>[o("h4",null,"Failed Imports: "+_(e.failedImports.length),1),e.unseenFailedImports?(p(),w(R,{key:0,id:"failedImportsIcon",title:"New Failed Imports"},{default:s(()=>[i(_(l.mdiBookAlert),1)]),_:1})):F("",!0)]),_:1}),r(P,null,{default:s(()=>[r(fe,{class:"highlight-table"},{default:s(()=>[t[1]||(t[1]=o("thead",null,[o("tr",null,[o("th",null,"Path"),o("th",null,"Created")])],-1)),o("tbody",null,[(p(!0),g(se,null,ie(e.failedImports,f=>(p(),g("tr",{key:`fi:${f.path}`},[o("td",null,_(f.path),1),o("td",Ue,[r(d,{dttm:f.createdAt},null,8,["dttm"])])]))),128))])]),_:1}),r(A,null,{default:s(()=>[r(x,{id:"failedImportsHelp"},{default:s(()=>[r(T,null,{default:s(()=>t[2]||(t[2]=[o("h4",null,"Failed Imports Help",-1)])),_:1,__:[2]}),r(P,null,{default:s(()=>[t[8]||(t[8]=o("p",null," These are Comic archives that have failed to import. This list is updated every time the library updates. You should probably review these files and fix or remove them. ",-1)),t[9]||(t[9]=o("h4",null,"Fixing comics",-1)),t[10]||(t[10]=o("p",null,[i(" Try using the zip fixer to fix comics: "),o("code",{class:"cli"},[i(" cp problem-comic.cbz /somewhere/safe/problem-comic.cbz.backup"),o("br"),i(" zip -F problem-comic.cbz --out fixed.zip"),o("br"),i(" mv fixed.zip problem-comic.cbz ")]),i(" You may also try "),o("code",null,"zip -FF"),i(" to fix comics which uses a different (not necissarily better) algorithm. If you fix some imports, and Codex does not immediately detect the change, poll the library which contains the fixed comics. ")],-1)),t[11]||(t[11]=o("h4",null,"Reporting Issues",-1)),o("p",null,[t[4]||(t[4]=i(" If the comic looks good to you, but still shows up as a failed import, it might be Codex's fault for not importing it correctly. Please file an ")),o("a",Oe,[t[3]||(t[3]=i("Issue Report")),r(R,{size:"small"},{default:s(()=>[i(_(l.mdiOpenInNew),1)]),_:1})]),t[5]||(t[5]=i(" and include the stack trace from the logs at ")),t[6]||(t[6]=o("code",null,"config/logs/codex.log",-1)),t[7]||(t[7]=i(" if you can. "))])]),_:1,__:[8,9,10,11]})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})])):F("",!0)}const Se=C(Ee,[["render",Re],["__scopeId","data-v-827c9a0b"]]),He={name:"AdminLibrariesTab",components:{AdminFailedImportsPanel:Se,AdminLibraryTable:K,AdminCreateUpdateDialog:j,AdminCustomCoversPanel:Ve},data(){return{AdminLibraryCreateUpdateInputs:$(G)}},computed:{...I(h,["normalLibraries"])},mounted(){this.loadTables(["Group","Library","FailedImport"])},methods:{...k(h,["loadTables"])}},$e={class:"tabHeader"};function Be(e,t,m,b,l,n){const d=u("AdminCreateUpdateDialog"),f=u("AdminLibraryTable"),y=u("AdminFailedImportsPanel"),c=u("AdminCustomCoversPanel");return p(),g("div",null,[o("header",$e,[r(d,{table:"Library",inputs:l.AdminLibraryCreateUpdateInputs},null,8,["inputs"])]),r(f,{items:e.normalLibraries,"sort-by":[{key:"path",order:"asc"}]},null,8,["items"]),r(U,null,{default:s(()=>[r(y,{id:"failedImports"})]),_:1}),r(U,null,{default:s(()=>[r(c,{id:"customCovers"})]),_:1}),t[0]||(t[0]=o("p",{id:"libraryHelp"}," Each Watched File Events box checked creates a thread to monitor the Library. An large number of watching threads may exceed the limits of your operating system or container. ",-1))])}const it=C(He,[["render",Be],["__scopeId","data-v-c699976c"]]);export{it as default};
