name: ğŸ§ª CI Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: macos-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13"]

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: âš¡ Install UV
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true

      - name: ğŸ”¨ Build package
        run: |
          uv build
          echo "âœ… Package built successfully"
          ls -la dist/

      - name: ğŸ§ª Test package build
        run: |
          echo "ğŸ§ª Testing package functionality..."

          # Test help command works
          sudo uv run fluidtop --help
          echo "âœ… Help command works"

          # Test package can be imported
          uv run python -c "import fluidtop.fluidtop; print('âœ… Package imports successfully')"

          # Test CLI entry point exists
          if command -v fluidtop >/dev/null 2>&1 || uv run which fluidtop >/dev/null 2>&1; then
            echo "âœ… CLI entry point found"
          else
            echo "âš ï¸  CLI entry point not in PATH (expected in development)"
          fi

      - name: ğŸ“¦ Test wheel installation
        run: |
          echo "ğŸ§ª Testing wheel installation..."

          # Create test environment and install wheel
          python -m venv test_wheel
          source test_wheel/bin/activate

          # Install the built wheel
          pip install dist/*.whl

          # Test import in clean environment
          python -c "import fluidtop.fluidtop; print('âœ… Wheel installs and imports correctly')"

          # Clean up
          deactivate
          rm -rf test_wheel

  lint:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: âš¡ Install UV
        uses: astral-sh/setup-uv@v6

      - name: ğŸ” Check package metadata
        run: |
          echo "ğŸ” Checking package configuration..."

          # Validate pyproject.toml syntax
          python -c "import tomllib; tomllib.load(open('pyproject.toml', 'rb'))" 2>/dev/null && echo "âœ… pyproject.toml syntax valid" || echo "âŒ pyproject.toml syntax invalid"

          # Check required fields exist
          uv run python -c "import tomllib; config = tomllib.load(open('pyproject.toml', 'rb')); project = config.get('project', {}); required = ['name', 'version', 'description', 'authors']; [print(f'âœ… {field}: {project[field]}') for field in required if field in project]; exit(1) if not all(field in project for field in required) else print('âœ… All required package metadata present')"

      - name: ğŸ” Validate dependencies
        run: |
          echo "ğŸ” Checking dependencies..."
          uv lock --check-hash || echo "âš ï¸  Lock file may need updating"
          echo "âœ… Dependencies check complete"
