
name: Build Python Package

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install miniconda
      uses: conda-incubator/setup-miniconda@v3
      with:
          python-version: 3.11
          channels: conda-forge,defaults
          channel-priority: true
          activate-environment: DATAMODEL
    - name: Check conda installation
      shell: bash -el {0}
      run: |
          conda info
          conda list
          conda config --show-sources
          conda config --show
          printenv | sort
  

    - name: Install build tools
      shell: bash -l {0}
      run: |
        conda install -y conda-build pip setuptools setuptools-scm build

    - name: Get version from SCM
      shell: bash -l {0}
      id: get_version
      run: |
        echo "version=$(python -m setuptools_scm)" >> "$GITHUB_OUTPUT"

    

    - name: Conda build with dynamic version
      shell: bash -l {0}
      env:
        SETUPTOOLS_SCM_PRETEND_VERSION: ${{ steps.get_version.outputs.version }}
      run: |
        conda build conda-recipe

    - name: Upload Conda build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: conda-artifacts
        path: /usr/share/miniconda3/conda-bld/
        
    - name: Upload built artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist-artifacts
        path: dist/

    - name: Build Python wheel (optional)
      shell: bash -l {0}
      run: python -m build
        
        


